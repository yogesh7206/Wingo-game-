<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wingo Game</title>
  <style>
    body { font-family: Arial; text-align: center; background: #f0f0f0; padding: 30px; }
    input, button, select { padding: 10px; margin: 5px; font-size: 16px; }
    .hidden { display: none; }
    .red { background: red; color: white; }
    .green { background: green; color: white; }
    .violet { background: purple; color: white; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #0055ff; color: white; }
  </style>
</head>
<body>

<div id="gameSection">
  <h1>Wingo Game</h1>
  <select id="gameType">
    <option value="30">30 Sec</option>
    <option value="60">1 Min</option>
    <option value="180">3 Min</option>
    <option value="300">5 Min</option>
  </select>
  <p id="countdown">‚è≥ Time Left: --</p>
  <p><strong>Current Period:</strong> <span id="periodDisplay">--</span></p>

  <h3>Game History</h3>
  <table>
    <thead>
      <tr>
        <th>Period</th>
        <th>Number</th>
        <th>Color</th>
      </tr>
    </thead>
    <tbody id="historyTable"></tbody>
  </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

  const app = initializeApp({
    apiKey: "AIzaSyBe5kGOwYS3FsF_9_q1pjxaWrF1glUe87c",
    authDomain: "wingologin.firebaseapp.com",
    databaseURL: "https://wingologin-default-rtdb.firebaseio.com",
    projectId: "wingologin",
    storageBucket: "wingologin.appspot.com",
    messagingSenderId: "605536859710",
    appId: "1:605536859710:web:ed9495775c8f8dd6a8836f"
  });

  const db = getDatabase(app);

  function getResultColor(num) {
    if (num === 5) return "VIOLET";
    else if ([1, 3, 7, 9, 0].includes(num)) return "RED";
    else return "GREEN";
  }

  function getPeriodId(duration, time) {
    const date = time.toISOString().slice(0, 10).replace(/-/g, '');
    const secondsSinceMidnight = time.getHours() * 3600 + time.getMinutes() * 60 + time.getSeconds();
    const index = Math.floor(secondsSinceMidnight / duration);
    return `${date}-${String(index + 1).padStart(3, '0')}`;
  }

  async function getAllResults(duration) {
    const resRef = ref(db, `results/${duration}`);
    const snapshot = await get(resRef);
    if (!snapshot.exists()) return;

    const data = snapshot.val();
    const entries = Object.entries(data).sort().reverse().slice(0, 10);
    const rows = entries.map(([period, result]) => {
      const emoji = result.color === "RED" ? "üî¥" : result.color === "GREEN" ? "üü¢" : "üü£";
      return `<tr>
        <td>${period}</td>
        <td style="color:${result.color.toLowerCase()}"><b>${result.number}</b></td>
        <td>${emoji}</td>
      </tr>`;
    });
    document.getElementById("historyTable").innerHTML = rows.join("");
  }

  function getNextRoundTime(seconds) {
    const now = new Date();
    return new Date(Math.ceil(now.getTime() / (seconds * 1000)) * (seconds * 1000));
  }

  function startRealTimeTimer() {
    clearInterval(window.timer);
    const gameType = parseInt(document.getElementById("gameType").value);
    const nextRound = getNextRoundTime(gameType);

    window.timer = setInterval(() => {
      const now = new Date();
      const diff = Math.floor((nextRound.getTime() - now.getTime()) / 1000);

      const periodId = getPeriodId(gameType, now);
      document.getElementById("periodDisplay").innerText = periodId;

      if (diff <= 0) {
        clearInterval(window.timer);

        const countNum = Math.floor(Math.random() * 10);
        const color = getResultColor(countNum);

        // Save result to Firebase
        set(ref(db, `results/${gameType}/${periodId}`), {
          number: countNum,
          color: color,
          timestamp: Date.now()
        });

        // Update history
        getAllResults(gameType);

        setTimeout(startRealTimeTimer, 1000);
      } else {
        document.getElementById("countdown").innerText = `‚è≥ Time Left: ${diff}s`;
      }
    }, 1000);
  }

  document.getElementById("gameType").onchange = () => {
    startRealTimeTimer();
    getAllResults(parseInt(document.getElementById("gameType").value));
  };

  // Start on load
  window.onload = () => {
    const gameType = parseInt(document.getElementById("gameType").value);
    startRealTimeTimer();
    getAllResults(gameType);
  };
</script>

</body>
</html>
