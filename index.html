<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wingo Game</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; text-align: center; }
    .hidden { display: none; }
    input, button, select { padding: 10px; margin: 5px; font-size: 16px; border-radius: 6px; }
    .red { background: #e53935; color: #fff; }
    .green { background: #43a047; color: #fff; }
    .violet { background: #8e24aa; color: #fff; }
    .big, .small { background: #ff9800; color: #fff; }
    .number-btn { background: #3949ab; color: #fff; margin: 2px; border-radius: 50%; width: 40px; height: 40px; }
    table { width: 100%; background: #fff; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px; border: 1px solid #ccc; }
    th { background: #0055ff; color: white; }
  </style>
</head>
<body>

<div id="loginSection">
  <h2>Login</h2>
  <input type="email" id="loginEmail" placeholder="Email"><br>
  <input type="password" id="loginPass" placeholder="Password"><br>
  <button onclick="loginUser()">Login</button>
  <p>Don't have an account? <a href="#" onclick="toggleRegister()">Register</a></p>
</div>

<div id="registerSection" class="hidden">
  <h2>Register</h2>
  <input type="email" id="regEmail" placeholder="Email"><br>
  <input type="password" id="regPass" placeholder="Password"><br>
  <button onclick="registerUser()">Register</button>
  <p>Already have an account? <a href="#" onclick="toggleRegister()">Login</a></p>
</div>

<div id="gameSection" class="hidden">
  <h2>Welcome, <span id="userEmail"></span></h2>
  <p>User ID: <span id="userIdDisplay"></span></p>
  <p>Balance: ₹<span id="wallet">0</span></p>
  <p>Period: <span id="periodDisplay">--</span></p>
  <p>⏳ Time Left: <span id="countdown">--</span></p>
  <select id="gameType">
    <option value="30">30 Sec</option>
    <option value="60">1 Min</option>
    <option value="180">3 Min</option>
    <option value="300">5 Min</option>
  </select><br>
  <input type="number" id="bet" placeholder="Enter Bet ₹"><br>

  <div>
    <button class="red" onclick="placeBet('color', 'RED')">Red</button>
    <button class="green" onclick="placeBet('color', 'GREEN')">Green</button>
    <button class="violet" onclick="placeBet('color', 'VIOLET')">Violet</button>
  </div>
  <div>
    <button class="big" onclick="placeBet('size', 'BIG')">Big</button>
    <button class="small" onclick="placeBet('size', 'SMALL')">Small</button>
  </div>
  <div>
    <p>Numbers:</p>
    <div id="numberButtons"></div>
  </div>

  <button onclick="logoutUser()">Logout</button>

  <h3>My Bet History</h3>
  <table>
    <thead>
      <tr><th>Period</th><th>Type</th><th>Value</th><th>Amount</th><th>Result</th></tr>
    </thead>
    <tbody id="betHistory"></tbody>
  </table>
</div>

<audio id="winSound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-notification-2018.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
import { getDatabase, ref, set, update, push, get, onValue, child } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBe5kGOwYS3FsF_9_q1pjxaWrF1glUe87c",
  authDomain: "wingologin.firebaseapp.com",
  databaseURL: "https://wingologin-default-rtdb.firebaseio.com",
  projectId: "wingologin",
  storageBucket: "wingologin.appspot.com",
  messagingSenderId: "605536859710",
  appId: "1:605536859710:web:ed9495775c8f8dd6a8836f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;
let currentBalance = 0;
let currentPeriod = null;

onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    document.getElementById("userEmail").innerText = user.email;
    document.getElementById("loginSection").classList.add("hidden");
    document.getElementById("registerSection").classList.add("hidden");
    document.getElementById("gameSection").classList.remove("hidden");
    get(ref(db, `users/${user.uid}`)).then(snap => {
      const data = snap.val();
      currentBalance = data.balance;
      document.getElementById("wallet").innerText = currentBalance.toFixed(2);
      document.getElementById("userIdDisplay").innerText = data.userId;
    });
    loadBetHistory();
    startGame();
  }
});

window.registerUser = () => {
  const email = document.getElementById("regEmail").value;
  const pass = document.getElementById("regPass").value;
  const userId = Math.floor(100000 + Math.random() * 900000).toString();
  createUserWithEmailAndPassword(auth, email, pass).then(cred => {
    set(ref(db, `users/${cred.user.uid}`), { email, balance: 100, userId });
    alert("Registered!");
    toggleRegister();
  }).catch(err => alert(err.message));
};

window.loginUser = () => {
  const email = document.getElementById("loginEmail").value;
  const pass = document.getElementById("loginPass").value;
  signInWithEmailAndPassword(auth, email, pass)
    .then(() => alert("Logged in!"))
    .catch(err => alert(err.message));
};

window.logoutUser = () => signOut(auth).then(() => location.reload());
window.toggleRegister = () => {
  document.getElementById("loginSection").classList.toggle("hidden");
  document.getElementById("registerSection").classList.toggle("hidden");
};

function getPeriodId(seconds, time) {
  const d = time.toISOString().slice(0, 10).replace(/-/g, '');
  const s = time.getHours() * 3600 + time.getMinutes() * 60 + time.getSeconds();
  const index = Math.floor(s / seconds);
  return `${d}-${String(index + 1).padStart(3, '0')}`;
}

function getResultColor(num) {
  if (num === 5) return "VIOLET";
  if ([2, 4, 6, 8].includes(num)) return "RED";
  return "GREEN";
}

function startGame() {
  const gameType = parseInt(document.getElementById("gameType").value);
  updateTimer(gameType);
  document.getElementById("gameType").onchange = () => startGame();
}

function updateTimer(gameType) {
  clearInterval(window.timer);
  window.timer = setInterval(() => {
    const now = new Date();
    const period = getPeriodId(gameType, now);
    currentPeriod = period;
    document.getElementById("periodDisplay").innerText = currentPeriod;
    const roundEnd = new Date(Math.ceil(Date.now() / (gameType * 1000)) * gameType * 1000);
    const diff = Math.floor((roundEnd - now) / 1000);
    document.getElementById("countdown").innerText = diff;

    if (diff <= 1) {
      clearInterval(window.timer);
      const number = Math.floor(Math.random() * 10);
      const color = getResultColor(number);
      const size = number >= 5 ? "BIG" : "SMALL";

      set(ref(db, `results/${gameType}/${currentPeriod}`), {
        number, color, size, time: Date.now()
      });

      evaluateBets(number, color, size);
      setTimeout(startGame, 1500);
    }
  }, 1000);
}

function evaluateBets(number, color, size) {
  const sound = document.getElementById("winSound");
  const uid = currentUser.uid;
  get(child(ref(db), `bets/${uid}/${currentPeriod}`)).then(snapshot => {
    const bets = snapshot.val();
    if (!bets) return;
    for (let key in bets) {
      const bet = bets[key];
      let win = false;
      if (bet.type === "color" && bet.value === color) win = true;
      if (bet.type === "size" && bet.value === size) win = true;
      if (bet.type === "number" && bet.value == number) win = true;

      if (win) {
        let payout = bet.amount * (bet.type === "number" ? 8.5 : bet.value === "VIOLET" ? 4.5 : 1.96);
        currentBalance += payout;
        update(ref(db, `users/${uid}`), { balance: currentBalance });
        sound.play();
      }

      update(ref(db, `bets/${uid}/${currentPeriod}/${key}`), { win });
    }
    document.getElementById("wallet").innerText = currentBalance.toFixed(2);
    loadBetHistory(); // Refresh history
  });
}

window.placeBet = (type, value) => {
  const amount = parseFloat(document.getElementById("bet").value);
  if (!amount || amount <= 0) return alert("Enter a valid amount");
  if (amount > currentBalance) return alert("Insufficient balance");

  const betData = { type, value, amount, win: null };
  push(ref(db, `bets/${currentUser.uid}/${currentPeriod}`), betData);
  currentBalance -= amount;
  update(ref(db, `users/${currentUser.uid}`), { balance: currentBalance });
  document.getElementById("wallet").innerText = currentBalance.toFixed(2);
  loadBetHistory();
};

function loadBetHistory() {
  const uid = currentUser.uid;
  get(ref(db, `bets/${uid}`)).then(snapshot => {
    const data = snapshot.val();
    const table = document.getElementById("betHistory");
    table.innerHTML = "";
    if (data) {
      Object.keys(data).reverse().forEach(period => {
        const bets = data[period];
        for (let key in bets) {
          const b = bets[key];
          const result = b.win === null ? "Pending" : b.win ? "✅ Win" : "❌ Lose";
          const row = `<tr><td>${period}</td><td>${b.type}</td><td>${b.value}</td><td>${b.amount}</td><td>${result}</td></tr>`;
          table.innerHTML += row;
        }
      });
    }
  });
}

for (let i = 0; i <= 9; i++) {
  const btn = document.createElement("button");
  btn.textContent = i;
  btn.className = "number-btn";
  btn.onclick = () => placeBet("number", i);
  document.getElementById("numberButtons").appendChild(btn);
}
</script>
</body>
</html>
