<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wingo Color Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding-bottom: 100px;
      text-align: center;
    }
    header {
      background: #222;
      color: white;
      padding: 1rem;
      font-size: 1.5rem;
    }
    .container {
      max-width: 400px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, button, select {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      font-size: 1rem;
    }
    .hidden {
      display: none;
    }
    .wallet {
      margin-top: 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>ðŸŽ® Wingo Color Game</header>

  <div class="container" id="authSection">
    <h3>Login</h3>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Password">
    <button onclick="login()">Login</button>
    <p>or</p>
    <h3>Register</h3>
    <input type="email" id="registerEmail" placeholder="Email">
    <input type="password" id="registerPassword" placeholder="Password">
    <input type="text" id="referralCode" placeholder="Referral Code (optional)">
    <button onclick="register()">Register</button>
  </div>
  <!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBe5kGOwYS3FsF_9_q1pjxaWrF1glUe87c",
    authDomain: "wingologin.firebaseapp.com",
    databaseURL: "https://wingologin-default-rtdb.firebaseio.com",
    projectId: "wingologin",
    storageBucket: "wingologin.firebasestorage.app",
    messagingSenderId: "605536859710",
    appId: "1:605536859710:web:ed9495775c8f8dd6a8836f",
    measurementId: "G-FLDY936H9P"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  function register() {
    const email = document.getElementById("registerEmail").value;
    const password = document.getElementById("registerPassword").value;
    const referral = document.getElementById("referralCode").value;

    auth.createUserWithEmailAndPassword(email, password)
      .then((userCred) => {
        const uid = userCred.user.uid;
        const userData = {
          balance: 100,
          referredBy: referral || null
        };
        db.ref("users/" + uid).set(userData);
        alert("Registered successfully! â‚¹100 added.");
        showGameUI();
      })
      .catch((error) => {
        alert(error.message);
      });
  }

  function login() {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;

    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        showGameUI();
      })
      .catch((error) => {
        alert(error.message);
      });
  }

  auth.onAuthStateChanged((user) => {
    if (user) {
      showGameUI();
    }
  });

  function showGameUI() {
    document.getElementById("authSection").style.display = "none";
    document.getElementById("gameSection").style.display = "block";
    const uid = auth.currentUser.uid;
    db.ref("users/" + uid + "/balance").on("value", (snapshot) => {
      document.getElementById("wallet").textContent = "Wallet: â‚¹" + snapshot.val();
    });
  }
</script>
  <script>
  function loadBetHistory() {
    const uid = auth.currentUser.uid;
    db.ref("bets").once("value").then((snapshot) => {
      const tbody = document.getElementById("betHistoryBody");
      tbody.innerHTML = ""; // Clear existing rows

      const bets = [];

      snapshot.forEach((periodSnap) => {
        const period = periodSnap.key;
        const userBet = periodSnap.child(uid).val();
        if (userBet) {
          bets.push({
            period: period,
            color: userBet.color,
            amount: userBet.amount
          });
        }
      });

      bets.sort((a, b) => parseInt(b.period) - parseInt(a.period));

      bets.forEach((bet) => {
        db.ref("results/" + bet.period + "/color").once("value").then((resultSnap) => {
          const resultColor = resultSnap.val();
          let resultText = "Pending";

          if (resultColor) {
            resultText = (resultColor === bet.color) ? "Win" : "Lose";
          }

          const row = `
            <tr>
              <td>${bet.period}</td>
              <td>${bet.color}</td>
              <td>â‚¹${bet.amount}</td>
              <td>${resultText}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      });
    });
  }

  auth.onAuthStateChanged((user) => {
    if (user) {
      loadBetHistory();
    }
  });
  </script>

<!-- Game Section UI -->
<div class="container hidden" id="gameSection">
  <div id="wallet">Wallet: â‚¹--</div>
  <div style="margin-top: 20px;">
    <label>Select Game Time:</label>
    <select id="gameType">
      <option value="60">1 Minute</option>
      <option value="180">3 Minutes</option>
    </select>
    <p>Period No: <span id="periodDisplay">--</span></p>
    <p>Time Left: <span id="countdown">--</span></p>
  </div>
</div>
  <script>
  let gameInterval;
  let countdownTime = 60;

  function startTimer() {
    clearInterval(gameInterval);

    const gameTypeSelect = document.getElementById("gameType");
    countdownTime = parseInt(gameTypeSelect.value); // 60 or 180

    updatePeriodDisplay();

    let remaining = countdownTime;
    document.getElementById("countdown").textContent = formatTime(remaining);

    gameInterval = setInterval(() => {
      remaining--;

      if (remaining <= 0) {
        remaining = countdownTime;
        updatePeriodDisplay();
      }

      document.getElementById("countdown").textContent = formatTime(remaining);
    }, 1000);
  }

  function formatTime(sec) {
    const m = Math.floor(sec / 60).toString().padStart(2, "0");
    const s = (sec % 60).toString().padStart(2, "0");
    return `${m}:${s}`;
  }

  function updatePeriodDisplay() {
    const now = new Date();
    const periodBase = now.getFullYear().toString().slice(-2)
                    + (now.getMonth() + 1).toString().padStart(2, '0')
                    + now.getDate().toString().padStart(2, '0');

    const totalMinutes = Math.floor(
      (now.getHours() * 60 + now.getMinutes()) * 60 + now.getSeconds()
    );
    const interval = parseInt(document.getElementById("gameType").value); // 60 or 180
    const periodIndex = Math.floor(totalMinutes / interval).toString().padStart(4, "0");

    const fullPeriod = periodBase + periodIndex;
    document.getElementById("periodDisplay").textContent = fullPeriod;
  }

  document.getElementById("gameType").addEventListener("change", startTimer);
  window.addEventListener("load", () => {
    if (document.getElementById("gameType")) {
      startTimer();
    }
  });
  </script>
  <!-- Wingo Game Betting UI -->
<div style="margin-top: 30px;">
  <h3>Place Your Bet</h3>
  <input type="number" id="betAmount" placeholder="Enter amount" style="width: 200px;" />
  <br><br>
  <button onclick="placeBet('green')">Green</button>
  <button onclick="placeBet('red')">Red</button>
  <button onclick="placeBet('violet')">Violet</button>
  <p id="betStatus"></p>
</div>

<script>
  function placeBet(color) {
    const amount = parseInt(document.getElementById("betAmount").value);
    const uid = auth.currentUser.uid;

    if (!amount || amount <= 0) {
      alert("Enter a valid bet amount");
      return;
    }

    // Get current wallet balance
    db.ref("users/" + uid + "/balance").once("value")
      .then((snapshot) => {
        const balance = snapshot.val() || 0;

        if (amount > balance) {
          alert("Insufficient wallet balance");
          return;
        }

        // Get current period
        const period = document.getElementById("periodDisplay").textContent;

        // Save bet in database
        const betData = {
          uid: uid,
          color: color,
          amount: amount,
          time: new Date().toISOString()
        };

        db.ref("bets/" + period + "/" + uid).set(betData);

        // Deduct from wallet
        db.ref("users/" + uid + "/balance").set(balance - amount);

        document.getElementById("betStatus").textContent = `You bet â‚¹${amount} on ${color} for period ${period}`;
      });
  }
</script>
  <script>
  function loadLeaderboard() {
    db.ref("users").once("value").then((snapshot) => {
      const players = [];

      snapshot.forEach((userSnap) => {
        const uid = userSnap.key;
        const user = userSnap.val();
        const balance = parseInt(user.balance) || 0;
        const email = user.email || uid.substring(0, 6); // fallback to part of UID

        players.push({
          email: email,
          balance: balance
        });
      });

      players.sort((a, b) => b.balance - a.balance);

      const tbody = document.getElementById("leaderboardBody");
      tbody.innerHTML = "";

      players.slice(0, 10).forEach((player, index) => {
        const row = `
          <tr>
            <td>${index + 1}</td>
            <td>${player.email}</td>
            <td>â‚¹${player.balance}</td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    });
  }

  auth.onAuthStateChanged((user) => {
    if (user) {
      loadLeaderboard();
    }
  });
  </script>
  <script>
  // Runs every second to check if it's time to generate a result
  function runResultScheduler() {
    setInterval(() => {
      const gameType = parseInt(document.getElementById("gameType").value); // 60 or 180
      const now = new Date();
      const totalSeconds = now.getMinutes() * 60 + now.getSeconds();

      if (totalSeconds % gameType === 0) {
        const period = document.getElementById("periodDisplay").textContent;
        generateResult(period);
      }
    }, 1000);
  }

  // Generate random result color and store in Firebase
  function generateResult(period) {
    const colors = ["green", "red", "violet"];
    const winColor = colors[Math.floor(Math.random() * colors.length)];

    db.ref("results/" + period).once("value").then((snapshot) => {
      if (!snapshot.exists()) {
        db.ref("results/" + period).set({
          color: winColor,
          time: new Date().toISOString()
        });

        payoutWinners(period, winColor);
      }
    });
  }

  // Payout users who won the round
  function payoutWinners(period, winColor) {
    db.ref("bets/" + period).once("value").then((snapshot) => {
      snapshot.forEach((child) => {
        const bet = child.val();
        const uid = bet.uid;
        const amount = parseInt(bet.amount);
        const betColor = bet.color;
        let payout = 0;

        if (betColor === winColor) {
          if (winColor === "green" || winColor === "red") {
            payout = amount * 2;
          } else if (winColor === "violet") {
            payout = amount * 4;
          }

          db.ref("users/" + uid + "/balance").once("value").then((snap) => {
            const current = parseInt(snap.val()) || 0;
            db.ref("users/" + uid + "/balance").set(current + payout);
          });
        }
      });
    });
  }

  // Start result logic only after user is logged in
  auth.onAuthStateChanged((user) => {
    if (user) {
      runResultScheduler();
    }
  });
              </script>
  
  <div id="historySection" style="margin-top: 40px;">
  <h3>Your Bet History</h3>
  <table border="1" style="margin: 0 auto; width: 90%; max-width: 500px;">
    <thead>
      <tr>
        <th>Period</th>
        <th>Color</th>
        <th>Amount</th>
        <th>Result</th>
      </tr>
    </thead>
    <tbody id="betHistoryBody">
      <!-- Filled by script -->
    </tbody>
  </table>
  </div>
  
  <div id="leaderboardSection" style="margin-top: 40px;">
  <h3>Top Players</h3>
  <table border="1" style="margin: 0 auto; width: 90%; max-width: 500px;">
    <thead>
      <tr>
        <th>Rank</th>
        <th>User</th>
        <th>Balance</th>
      </tr>
    </thead>
    <tbody id="leaderboardBody">
      <!-- Filled by JS -->
    </tbody>
  </table>
  </div>
