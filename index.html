<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wingo Game</title>
  <style>
    body { font-family: Arial; background: #f4f6fa; margin: 0; padding-bottom: 80px; text-align: center; }
    .section { display: none; padding: 20px; }
    #homeSection, #gameSection, #walletSection, #historySection, #leaderboardSection, #adminPanel { display: none; }
    button { padding: 10px 20px; margin: 10px; }
    table { border-collapse: collapse; width: 90%; margin: 0 auto; }
    th, td { border: 1px solid #ccc; padding: 8px; }
  </style>
</head>
<body>
  <h2>ðŸŽ® Wingo Color Prediction Game</h2>

  <!-- Auth Section -->
  <div id="authSection">
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
    <button onclick="register()">Register</button>
    <p id="authMessage"></p>
  </div>

  <!-- Navigation -->
  <div id="nav" style="display:none;">
    <button onclick="showSection('homeSection')">Home</button>
    <button onclick="showSection('gameSection')">Wingo</button>
    <button onclick="showSection('walletSection')">Wallet</button>
    <button onclick="showSection('historySection')">History</button>
    <button onclick="showSection('leaderboardSection')">Leaderboard</button>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- Sections -->
  <div id="homeSection" class="section">
    <h3>Welcome!</h3>
    <p id="userEmail"></p>
    <p>Wallet: â‚¹<span id="walletBalance">0</span></p>
    <p>Referral Code: <span id="referralCode"></span></p>
  </div>
  <!-- Wingo Game Section -->
  <div id="gameSection" class="section">
    <h3>Wingo Game</h3>
    <p>Period No: <span id="periodNumber"></span></p>
    <p>Timer: <span id="countdownTimer"></span>s</p>
    <button onclick="placeBet('green')">Bet Green</button>
    <button onclick="placeBet('red')">Bet Red</button>
    <button onclick="placeBet('violet')">Bet Violet</button>
  </div>

  <!-- Wallet -->
  <div id="walletSection" class="section">
    <h3>Wallet</h3>
    <p>Balance: â‚¹<span id="walletBalance2">0</span></p>
    <button onclick="addMoney()">Add â‚¹100</button>
  </div>

  <!-- History Section -->
  <div id="historySection" class="section">
    <h3>Bet History</h3>
    <table>
      <thead><tr><th>Period</th><th>Color</th><th>Status</th></tr></thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>

  <!-- Leaderboard and Admin Panel come in later parts -->

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBe5kGOwYS3FsF_9_q1pjxaWrF1glUe87c",
    authDomain: "wingologin.firebaseapp.com",
    databaseURL: "https://wingologin-default-rtdb.firebaseio.com",
    projectId: "wingologin",
    storageBucket: "wingologin.appspot.com",
    messagingSenderId: "605536859710",
    appId: "1:605536859710:web:ed9495775c8f8dd6a8836f",
    measurementId: "G-FLDY936H9P"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  function showSection(id) {
    document.querySelectorAll('.section').forEach(div => div.style.display = 'none');
    document.getElementById(id).style.display = 'block';
  }

  function login() {
    const email = email.value;
    const pass = password.value;
    auth.signInWithEmailAndPassword(email, pass)
      .then(() => location.reload())
      .catch(e => authMessage.innerText = e.message);
  }

  function register() {
    const email = email.value;
    const pass = password.value;
    auth.createUserWithEmailAndPassword(email, pass)
      .then(cred => {
        db.ref("users/" + cred.user.uid).set({
          email: email,
          balance: 100,
          referral: "",
          bets: {}
        });
        location.reload();
      })
      .catch(e => authMessage.innerText = e.message);
  }

  function logout() {
    auth.signOut().then(() => location.reload());
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById("authSection").style.display = "none";
      document.getElementById("nav").style.display = "block";
      showSection('homeSection');
      loadUser(user);
    }
  });
</script>
<script>
  let currentUser = null;
  let currentPeriod = 0;
  let timeLeft = 0;

  function loadUser(user) {
    currentUser = user;
    document.getElementById("userEmail").innerText = user.email;

    db.ref("users/" + user.uid).once("value").then(snapshot => {
      const data = snapshot.val();
      document.getElementById("walletBalance").innerText = data.balance || 0;
      document.getElementById("walletBalance2").innerText = data.balance || 0;
      const referralCode = user.uid.slice(0, 6).toUpperCase();
      document.getElementById("referralCode").innerText = referralCode;
    });
  }

  function addMoney() {
    db.ref("users/" + currentUser.uid).once("value").then(snapshot => {
      let balance = snapshot.val().balance || 0;
      balance += 100;
      db.ref("users/" + currentUser.uid).update({ balance });
      document.getElementById("walletBalance").innerText = balance;
      document.getElementById("walletBalance2").innerText = balance;
    });
  }

  // Period Number and Countdown Timer
  function updateTimerAndPeriod() {
    const now = Date.now();
    const roundMs = 60 * 1000; // 1 min per round
    const startTime = new Date("2024-01-01T00:00:00Z").getTime();
    const diff = now - startTime;
    currentPeriod = Math.floor(diff / roundMs);
    timeLeft = 60 - Math.floor((diff % roundMs) / 1000);
    document.getElementById("periodNumber").innerText = currentPeriod;
    document.getElementById("countdownTimer").innerText = timeLeft;
  }

  setInterval(() => {
    updateTimerAndPeriod();
    if (timeLeft === 5) {
      generateResult();
    }
  }, 1000);
</script>
<script>
  function placeBet(color) {
    const amount = 10; // Fixed bet amount
    const uid = currentUser.uid;
    db.ref("users/" + uid).once("value").then(snapshot => {
      const user = snapshot.val();
      if (user.balance < amount) {
        alert("Not enough balance");
        return;
      }

      // Deduct balance
      const newBalance = user.balance - amount;
      db.ref("users/" + uid).update({ balance: newBalance });
      document.getElementById("walletBalance").innerText = newBalance;
      document.getElementById("walletBalance2").innerText = newBalance;

      // Save bet
      const betRef = db.ref("bets/" + currentPeriod + "/" + uid);
      betRef.set({ color, amount, status: "pending" });

      // Save in user history
      const userBetRef = db.ref("users/" + uid + "/bets/" + currentPeriod);
      userBetRef.set({ color, amount, status: "pending" });

      alert("Bet placed for " + color);
    });
  }

  function generateResult() {
    const resultRef = db.ref("results/" + currentPeriod);
    resultRef.once("value").then(snapshot => {
      if (snapshot.exists()) return; // Already generated

      const colors = ["red", "green", "violet"];
      const resultColor = colors[Math.floor(Math.random() * 3)];
      resultRef.set({ color: resultColor });

      // Fetch all bets for the period
      db.ref("bets/" + currentPeriod).once("value").then(betsSnap => {
        betsSnap.forEach(child => {
          const uid = child.key;
          const bet = child.val();
          const win = bet.color === resultColor;

          db.ref("users/" + uid).once("value").then(userSnap => {
            const user = userSnap.val();
            let balance = user.balance || 0;
            if (win) balance += bet.amount * 2;

            db.ref("users/" + uid).update({ balance });
            db.ref("users/" + uid + "/bets/" + currentPeriod + "/status").set(win ? "win" : "lose");
          });
        });
      });
    });
  }
          </script>
          <!-- Bet History UI is already present in Part 2 -->

<script>
  function loadBetHistory() {
    db.ref("users/" + currentUser.uid + "/bets").limitToLast(10).once("value").then(snapshot => {
      const body = document.getElementById("historyBody");
      body.innerHTML = "";
      snapshot.forEach(child => {
        const period = child.key;
        const bet = child.val();
        const row = `<tr>
          <td>${period}</td>
          <td>${bet.color}</td>
          <td>${bet.status}</td>
        </tr>`;
        body.innerHTML += row;
      });
    });
  }

  // Call this after auth
  auth.onAuthStateChanged(user => {
    if (user) {
      loadBetHistory();
    }
  });
</script>

<!-- Leaderboard Section -->
<div id="leaderboardSection" class="section">
  <h3>Leaderboard (Top Winners)</h3>
  <ol id="leaderboardList"></ol>
</div>

<script>
  function loadLeaderboard() {
    db.ref("users").once("value").then(snapshot => {
      const scores = [];
      snapshot.forEach(child => {
        const user = child.val();
        const total = Object.values(user.bets || {}).reduce((sum, b) => {
          return sum + (b.status === "win" ? b.amount : 0);
        }, 0);
        scores.push({ email: user.email, win: total });
      });

      scores.sort((a, b) => b.win - a.win);
      const top = scores.slice(0, 10);
      const list = document.getElementById("leaderboardList");
      list.innerHTML = "";
      top.forEach(item => {
        list.innerHTML += `<li>${item.email}: â‚¹${item.win}</li>`;
      });
    });
  }

  auth.onAuthStateChanged(user => {
    if (user) loadLeaderboard();
  });
</script>

<!-- Admin Panel to override result manually -->
<div id="adminPanel" class="section">
  <h3>Admin Panel</h3>
  <input id="adminPeriod" placeholder="Period No" />
  <select id="adminColor">
    <option value="red">Red</option>
    <option value="green">Green</option>
    <option value="violet">Violet</option>
  </select>
  <button onclick="overrideResult()">Set Result</button>
</div>

<script>
  function overrideResult() {
    const p = document.getElementById("adminPeriod").value;
    const c = document.getElementById("adminColor").value;
    db.ref("results/" + p).set({ color: c });
    alert("Result set for period " + p);
  }
</script>
<!-- Optional Footer -->
<footer style="position:fixed; bottom:0; width:100%; background:#eee; padding:10px;">
  <p>&copy; 2025 Wingo Game. All rights reserved.</p>
</footer>

<!-- Close body and html -->
</body>
</html>
