<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Win89 - VIP Earnings (Demo)</title>
  <meta name="description" content="Demo VIP earnings site (educational). Use your Firebase config before publishing." />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f3f6f8;color:#222}
    .container{max-width:980px;margin:18px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
    header h1{margin:0;font-size:20px;color:#0b6}
    .card{background:#fff;border-radius:8px;padding:12px;margin:12px 0;box-shadow:0 1px 6px rgba(0,0,0,.05)}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
    @media(max-width:880px){.grid{grid-template-columns:1fr}}
    .center{text-align:center}
    button{padding:8px 12px;border-radius:6px;border:none;background:#0b6;color:#fff;cursor:pointer}
    input,select{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%}
    .muted{color:#666;font-size:13px}
    .small{font-size:13px}
    .plan{display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid #e6eee9;border-radius:8px;margin:8px 0}
    .plan .left{max-width:70%}
    .tx{font-size:13px;padding:8px;border-bottom:1px solid #f0f0f0}
    .nav{display:flex;gap:6px}
    .danger{background:#e53935}
    .info{background:#1976d2}
  </style>

  <!-- FIREBASE SDK (v8 - non-modular) - works on GitHub Pages -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Yogesh (Demo)</h1>
      <div class="nav">
        <div id="userBox" class="muted small">Not signed in</div>
      </div>
    </header>

    <div class="grid">
      <main>
        <!-- Auth / Account Card -->
        <div id="authCard" class="card">
          <div id="authForms">
            <h3>Sign In / Register</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <input id="email" placeholder="Email" />
              <input id="password" type="password" placeholder="Password" />
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="btnSignIn">Sign In</button>
              <button id="btnRegister">Register</button>
              <button id="btnSignOut" style="display:none;background:#888">Sign Out</button>
            </div>
            <div style="margin-top:8px">
              <input id="refCode" placeholder="Referral code (optional)" />
            </div>
            <p class="muted small">Note: This is a demo. No real payments. Replace Firebase config to run.</p>
          </div>

          <div id="accountPanel" style="display:none">
            <h3>Your Account</h3>
            <p><b>Wallet:</b> ₹<span id="walletBalance">0.00</span></p>
            <p><b>Referral code:</b> <span id="myRefCode">-</span></p>
            <p class="muted small">Invite friends with your referral code to earn referral bonuses (demo).</p>

            <h4>VIP Plans</h4>
            <div id="plansContainer"></div>

            <h4>Active Plans</h4>
            <div id="activePlansDiv" class="muted small">No active plans</div>

            <h4>Transactions</h4>
            <div id="txList" style="max-height:220px;overflow:auto;border:1px solid #f0f0f0;border-radius:6px"></div>

            <h4>Withdraw</h4>
            <input id="withdrawAmount" placeholder="Amount to withdraw" />
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="btnRequestWithdraw">Request Withdrawal</button>
            </div>
          </div>
        </div>
      </main>

      <aside>
        <div class="card">
          <h3>Admin Panel</h3>
          <p class="muted small">Admin actions (only works if signed in as adminEmail).</p>
          <p><b>Current admin email:</b> <span id="sandhyabaghel905@gmail.com"></span></p>

          <div id="adminControls" style="display:none">
            <h4>Add / Edit VIP Plan</h4>
            <input id="planName" placeholder="Name e.g., VIP1" />
            <input id="planPrice" placeholder="Price (₹)" />
            <input id="planDaily" placeholder="Daily earning (₹)" />
            <input id="planDays" placeholder="Duration (days)" />
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="btnSavePlan">Save Plan</button>
              <button id="btnReloadPlans" class="info">Reload Plans</button>
            </div>

            <h4 style="margin-top:12px">Run Daily Payouts</h4>
            <p class="muted small">This credits daily earnings to eligible users (demo).</p>
            <div style="display:flex;gap:8px">
              <button id="btnRunDaily" class="danger">Run Daily Payouts (Admin)</button>
            </div>

            <h4 style="margin-top:12px">Pending Withdrawals</h4>
            <div id="withdrawRequests" style="max-height:200px;overflow:auto;border:1px solid #f0f0f0;border-radius:6px;margin-top:6px"></div>
          </div>

        </div>

        <div class="card" style="margin-top:12px">
          <h4>How demo payouts work</h4>
          <ol class="muted small">
            <li>When a user buys a plan, we store start date & duration.</li>
            <li>On each site open (or when admin runs payouts), missed daily credits are added to wallet.</li>
            <li>Withdrawals are requests that admin approves (mocked).</li>
          </ol>
        </div>
      </aside>
    </div>
  </div>

<script>
/*
  === IMPORTANT ===
  1) The firebaseConfig below is set to your project (as requested).
  2) Change adminEmail variable to your real admin email to access admin controls.
  3) This is a demo. Do NOT use for real money without legal compliance.
*/

// ---------- FIREBASE CONFIG (your config) ----------
var firebaseConfig = {
  apiKey: "AIzaSyDvF1KrDDRZJucp-78dbvmQ34Oi3j17Rrk",
  authDomain: "investment-website-deml.firebaseapp.com",
  projectId: "investment-website-deml",
  storageBucket: "investment-website-deml.firebasestorage.app",
  messagingSenderId: "814451995593",
  appId: "1:814451995593:web:55e3280d9cb43200f1ee18",
  measurementId: "G-8FKZE5NNSX"
};
// ---------------------------------------------------------------------
firebase.initializeApp(firebaseConfig);

// Admin email you will use to access admin panel (change to your email)
const adminEmail = "admin@example.com";
document.getElementById('adminEmailDisplay').innerText = adminEmail;

// Realtime DB refs
const db = firebase.database();
const auth = firebase.auth();

const plansRef = db.ref('plans');
const usersRef = db.ref('users');
const txRef = db.ref('transactions');
const withdrawRef = db.ref('withdrawals');

// Sample plans - if DB empty we will seed them
const defaultPlans = [
  { id: 'vip1', name: 'VIP1', price: 290, daily: 234.9, days: 47 },
  { id: 'vip2', name: 'VIP2', price: 3990, daily: 3313.7, days: 47 },
  { id: 'vip3', name: 'VIP3', price: 9990, daily: 830, days: 47 }
];

// ---------- UI elements ----------
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const btnSignIn = document.getElementById('btnSignIn');
const btnRegister = document.getElementById('btnRegister');
const btnSignOut = document.getElementById('btnSignOut');
const userBox = document.getElementById('userBox');
const accountPanel = document.getElementById('accountPanel');
const authForms = document.getElementById('authForms');
const walletBalanceSpan = document.getElementById('walletBalance');
const myRefCodeSpan = document.getElementById('myRefCode');
const plansContainer = document.getElementById('plansContainer');
const txList = document.getElementById('txList');

const btnRequestWithdraw = document.getElementById('btnRequestWithdraw');
const withdrawAmountInput = document.getElementById('withdrawAmount');
const refCodeInput = document.getElementById('refCode');

const adminControls = document.getElementById('adminControls');
const planName = document.getElementById('planName');
const planPrice = document.getElementById('planPrice');
const planDaily = document.getElementById('planDaily');
const planDays = document.getElementById('planDays');
const btnSavePlan = document.getElementById('btnSavePlan');
const btnReloadPlans = document.getElementById('btnReloadPlans');
const btnRunDaily = document.getElementById('btnRunDaily');
const withdrawRequests = document.getElementById('withdrawRequests');

// ---------- Auth handlers ----------
btnSignIn.addEventListener('click', ()=> {
  const e=emailInput.value.trim(), p=passwordInput.value;
  if(!e||!p){alert('Email & password required');return;}
  auth.signInWithEmailAndPassword(e,p).catch(err=>alert(err.message));
});

btnRegister.addEventListener('click', ()=> {
  const e=emailInput.value.trim(), p=passwordInput.value;
  const ref = refCodeInput.value.trim() || null;
  if(!e||!p){alert('Email & password required');return;}
  auth.createUserWithEmailAndPassword(e,p)
    .then(cred=>{
      const uid = cred.user.uid;
      const myRef = makeRefCode();
      usersRef.child(uid).set({
        email:e,
        wallet:0,
        refCode: myRef,
        referredBy: ref,
        createdAt: Date.now(),
        activePlans: {},
        lastPayout: Date.now()
      });
      // give referral bonus if referred
      if(ref){
        usersRef.orderByChild('refCode').equalTo(ref).once('value', snap=>{
          if(snap.exists()){
            snap.forEach(ss=>{
              const refUid = ss.key;
              const bonus = 20; // demo referral bonus
              usersRef.child(refUid).transaction(u=>{
                if(u){
                  u.wallet = (u.wallet||0) + bonus;
                }
                return u;
              });
              txRef.push({ uid: refUid, type:'referral_bonus', amount:bonus, time:Date.now(), from:uid });
            });
          }
        });
      }
    })
    .catch(err=>alert(err.message));
});

btnSignOut.addEventListener('click', ()=> {
  auth.signOut();
});

// ---------- Utility ----------
function makeRefCode(){
  return 'R' + Math.random().toString(36).substring(2,9).toUpperCase();
}
function formatRs(x){ return (Math.round((x||0)*100)/100).toFixed(2); }

// ---------- On auth state change ----------
let currentUser = null;
auth.onAuthStateChanged(user => {
  if(user){
    currentUser = user;
    userBox.innerText = user.email;
    btnSignOut.style.display = 'inline-block';
    authForms.style.display = 'none';
    accountPanel.style.display = 'block';

    // create user record if missing
    usersRef.child(user.uid).once('value', snap => {
      if(!snap.exists()){
        usersRef.child(user.uid).set({ email: user.email, wallet:0, refCode: makeRefCode(), createdAt: Date.now(), activePlans:{}, lastPayout: Date.now()});
      }
      refreshUserUI();
    });

    // show admin controls if current user is adminEmail
    if(user.email === adminEmail){
      adminControls.style.display = 'block';
    } else {
      adminControls.style.display = 'none';
    }

    // run automatic payouts for this user (on-open)
    runAutoPayoutForUser(user.uid);
    loadWithdrawRequests(); // admin list
  } else {
    currentUser = null;
    userBox.innerText = 'Not signed in';
    btnSignOut.style.display = 'none';
    authForms.style.display = 'block';
    accountPanel.style.display = 'none';
    adminControls.style.display = 'none';
  }
  document.getElementById('adminEmailDisplay').innerText = adminEmail;
  loadPlansToUI();
});

// ---------- Seed default plans if none exist ----------
plansRef.once('value', snap=>{
  if(!snap.exists()){
    defaultPlans.forEach(p=>{
      plansRef.child(p.id).set(p);
    });
  }
  loadPlansToUI();
});

// ---------- Load Plans UI ----------
function loadPlansToUI(){
  plansRef.once('value', snap=>{
    plansContainer.innerHTML = '';
    if(!snap.exists()) return;
    snap.forEach(child=>{
      const p = child.val(); p.id = child.key;
      const div = document.createElement('div'); div.className='plan';
      div.innerHTML = `
        <div class="left">
          <b>${p.name}</b> <div class="muted small">₹${formatRs(p.price)} — ${p.days} days</div>
          <div class="muted small">Daily earning: ₹${formatRs(p.daily)}</div>
        </div>
        <div class="right">
          <button data-plan='${p.id}' class="buyBtn">Buy</button>
        </div>
      `;
      plansContainer.appendChild(div);
    });

    // attach buy handlers
    Array.from(document.getElementsByClassName('buyBtn')).forEach(btn=>{
      btn.addEventListener('click', e=>{
        if(!currentUser){ alert('Sign in first'); return; }
        const planId = btn.getAttribute('data-plan');
        buyPlan(planId);
      });
    });
  });
}

// ---------- Buy Plan (Demo flow) ----------
function buyPlan(planId){
  usersRef.child(currentUser.uid).once('value', snap=>{
    const u = snap.val();
    plansRef.child(planId).once('value', psnap=>{
      if(!psnap.exists()) return alert('Plan not found');
      const plan = psnap.val();
      const proceed = confirm(`Buy ${plan.name} for ₹${plan.price}? (Demo: will deduct from wallet)`);
      if(!proceed) return;
      usersRef.child(currentUser.uid).transaction(user=>{
        if(user){
          user.wallet = (user.wallet||0) - plan.price;
          if(!user.activePlans) user.activePlans = {};
          const key = planId + '_' + Date.now();
          user.activePlans[key] = { planId: planId, name: plan.name, price: plan.price, daily: plan.daily, days: plan.days, start: Date.now(), creditedDays:0 };
        }
        return user;
      }, (err,snap2)=> {
        if(err) return alert('Error purchasing plan');
        txRef.push({ uid: currentUser.uid, type:'buy', planId:planId, amount: plan.price, time:Date.now() });
        alert('Plan purchased (demo).');
        refreshUserUI();
      });
    });
  });
}

// ---------- Refresh user UI ----------
function refreshUserUI(){
  if(!currentUser) return;
  usersRef.child(currentUser.uid).on('value', snap=>{
    const u = snap.val();
    walletBalanceSpan.innerText = formatRs(u.wallet || 0);
    myRefCodeSpan.innerText = u.refCode || '-';
    // transactions
    txRef.orderByChild('uid').equalTo(currentUser.uid).limitToLast(50).once('value', tsnap=>{
      txList.innerHTML = '';
      if(tsnap.exists()){
        const arr = [];
        tsnap.forEach(t=>{
          arr.push(t.val());
        });
        arr.reverse();
        arr.forEach(t=>{
          const el = document.createElement('div');
          el.className = 'tx';
          el.innerHTML = `<div><b>${t.type}</b> <span class="muted small">₹${formatRs(t.amount||0)}</span></div>
                          <div class="muted small">${new Date((t.time||0)).toLocaleString()}</div>`;
          txList.appendChild(el);
        });
      } else {
        txList.innerHTML = '<div class="muted small">No transactions yet.</div>';
      }
    });

    // update active plans list
    const ap = u.activePlans || {};
    let any=false;
    let html = '';
    for(const k in ap){
      any=true;
      const p = ap[k];
      const daysPassed = Math.floor((Date.now() - p.start) / (1000*60*60*24));
      const remaining = Math.max(0, p.days - daysPassed);
      html += `<div class="muted small"><b>${p.name}</b> — started ${new Date(p.start).toLocaleDateString()} — remaining days: ${remaining}</div>`;
    }
    document.getElementById('activePlansDiv').innerHTML = any ? html : 'No active plans';
  });
}

// ---------- Withdraw request (demo) ----------
btnRequestWithdraw.addEventListener('click', ()=>{
  if(!currentUser) return alert('Sign in');
  const amt = parseFloat(withdrawAmountInput.value);
  if(!amt || amt<=0) return alert('Enter valid amount');
  withdrawRef.push({ uid: currentUser.uid, amount: amt, time: Date.now(), status:'pending' });
  alert('Withdrawal requested (demo). Admin must approve.');
  withdrawAmountInput.value = '';
});

// ---------- Admin: load withdraw requests ----------
function loadWithdrawRequests(){
  withdrawRef.orderByChild('status').equalTo('pending').on('value', snap=>{
    withdrawRequests.innerHTML = '';
    if(!snap.exists()) return withdrawRequests.innerHTML = '<div class="muted small">No pending withdrawals</div>';
    snap.forEach(child=>{
      const r = child.val(); r.key = child.key;
      const div = document.createElement('div'); div.className = 'tx';
      div.innerHTML = `<div><b>UID:</b> ${r.uid} — ₹${formatRs(r.amount)}</div>
                       <div class="muted small">${new Date(r.time).toLocaleString()}</div>
                       <div style="margin-top:6px"><button data-key="${r.key}" class="approveBtn">Approve</button></div>`;
      withdrawRequests.appendChild(div);
    });
    Array.from(document.getElementsByClassName('approveBtn')).forEach(btn=>{
      btn.addEventListener('click', e=>{
        const key = btn.getAttribute('data-key');
        approveWithdraw(key);
      });
    });
  });
}

// Admin approve withdrawal (demo)
function approveWithdraw(key){
  if(!currentUser || currentUser.email !== adminEmail) return alert('Admin only');
  withdrawRef.child(key).once('value', snap=>{
    if(!snap.exists()) return alert('Not found');
    const r = snap.val();
    usersRef.child(r.uid).transaction(u=>{
      if(u){
        u.wallet = (u.wallet||0) - r.amount;
      }
      return u;
    }, (err, ss)=>{
      if(err) return alert('Error processing');
      withdrawRef.child(key).update({ status:'paid', paidAt: Date.now(), processedBy: currentUser.uid });
      txRef.push({ uid: r.uid, type:'withdrawal', amount: -r.amount, time: Date.now() });
      alert('Withdrawal approved (demo). Marked paid.');
    });
  });
}

// ---------- Admin: Save Plan ----------
btnSavePlan.addEventListener('click', ()=>{
  if(!currentUser || currentUser.email !== adminEmail) return alert('Admin only');
  const name = planName.value.trim(), price = parseFloat(planPrice.value), daily = parseFloat(planDaily.value), days = parseInt(planDays.value);
  if(!name || !price || !daily || !days) return alert('Fill plan fields');
  const id = name.toLowerCase().replace(/\s+/g,'_') + '_' + Date.now();
  plansRef.child(id).set({ id:id, name:name, price:price, daily:daily, days:days }, ()=> {
    alert('Plan saved');
    planName.value=''; planPrice.value=''; planDaily.value=''; planDays.value='';
    loadPlansToUI();
  });
});

btnReloadPlans.addEventListener('click', ()=> loadPlansToUI());

// ---------- Payout logic (credits missed days) ----------
/*
 For each active plan in user.activePlans:
   count daysPassed = floor((now - start) / 1day)
   eligibleDays = min(days, daysPassed) - creditedDays
   if eligibleDays > 0:
     credit eligibleDays * daily to user.wallet
     increment creditedDays
     record transaction(s)
*/

function runAutoPayoutForUser(uid){
  usersRef.child(uid).once('value', snap=>{
    if(!snap.exists()) return;
    const u = snap.val();
    let updates = {};
    let txs = [];
    const now = Date.now();
    const aps = u.activePlans || {};
    let any=false;
    for(const key in aps){
      const p = aps[key];
      const daysPassed = Math.floor((now - p.start) / (1000*60*60*24));
      const eligible = Math.min(p.days, daysPassed);
      const toCredit = Math.max(0, eligible - (p.creditedDays||0));
      if(toCredit>0){
        any=true;
        updates['activePlans/'+key+'/creditedDays'] = (p.creditedDays||0) + toCredit;
        updates['wallet'] = (u.wallet||0) + (toCredit * p.daily);
        txs.push({ uid: uid, type:'payout', amount: toCredit * p.daily, plan: p.name, days: toCredit, time: Date.now() });
      }
    }
    if(any){
      usersRef.child(uid).update(updates, 
                                            err=>{if(!err){
          txs.forEach(t => txRef.push(t));
          // optional: notify user
        }
      });
    }
  });
}

// ---------- Admin: Run daily payouts for all users ----------
btnRunDaily.addEventListener('click', ()=>{
  if(!currentUser || currentUser.email !== adminEmail) return alert('Admin only');
  if(!confirm('Run daily payouts for ALL users now?')) return;
  usersRef.once('value', snap=>{
    const now = Date.now();
    snap.forEach(child=>{
      const uid = child.key; const u = child.val();
      let updates = {};
      let txs = [];
      const aps = u.activePlans || {};
      let any=false;
      for(const key in aps){
        const p = aps[key];
        const daysPassed = Math.floor((now - p.start) / (1000*60*60*24));
        const eligible = Math.min(p.days, daysPassed);
        const toCredit = Math.max(0, eligible - (p.creditedDays||0));
        if(toCredit>0){
          any=true;
          updates['activePlans/'+key+'/creditedDays'] = (p.creditedDays||0) + toCredit;
          updates['wallet'] = (u.wallet||0) + (toCredit * p.daily);
          txs.push({ uid: uid, type:'payout', amount: toCredit * p.daily, plan: p.name, days: toCredit, time: Date.now() });
        }
      }
      if(any){
        usersRef.child(uid).update(updates, err=>{
          if(!err){
            txs.forEach(t=> txRef.push(t));
          }
        });
      }
    });
    alert('Admin: daily payouts run (demo).');
  });
});

// ---------- Load withdraw requests (admin) ----------
function loadWithdrawRequests(){
  withdrawRef.orderByChild('status').equalTo('pending').on('value', snap=>{
    withdrawRequests.innerHTML = '';
    if(!snap.exists()) return withdrawRequests.innerHTML = '<div class="muted small">No pending withdrawals</div>';
    snap.forEach(child=>{
      const r = child.val(); r.key = child.key;
      const div = document.createElement('div'); div.className = 'tx';
      div.innerHTML = `<div><b>User:</b> ${r.uid} — ₹${formatRs(r.amount)}</div>
                       <div class="muted small">${new Date(r.time).toLocaleString()}</div>
                       <div style="margin-top:6px"><button data-key="${r.key}" class="approveBtn">Approve</button></div>`;
      withdrawRequests.appendChild(div);
    });
    Array.from(document.getElementsByClassName('approveBtn')).forEach(btn=>{
      btn.addEventListener('click', e=>{
        const key = btn.getAttribute('data-key');
        approveWithdraw(key);
      });
    });
  });
}

// initial load (plans + withdraws)
loadPlansToUI();
loadWithdrawRequests();

</script>
</body>
</html>
   
