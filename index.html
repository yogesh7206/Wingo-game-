<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wingo Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6fa;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #1976d2;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 22px;
    }
    .container {
      padding: 20px;
    }
    input, button, select {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .btn-red { background: #e53935; color: white; }
    .btn-green { background: #43a047; color: white; }
    .btn-violet { background: #8e24aa; color: white; }
    .btn-big, .btn-small { background: #ff9800; color: white; }
    .number-btn {
      background: #3949ab;
      color: white;
      margin: 2px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      border: none;
    }
    .hidden { display: none; }
    table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background-color: #1976d2;
      color: white;
    }
    .nav-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      background-color: #ffffff;
      border-top: 1px solid #ccc;
    }
    .nav-btn {
      flex: 1;
      text-align: center;
      padding: 10px;
      font-size: 14px;
    }
    .nav-btn.active {
      background-color: #e0e0e0;
    }
  </style>
</head>
<body>
  <header>üéØ Wingo Color Prediction</header>
  <div class="container">

    <!-- Login -->
    <div id="loginSection">
      <h3>Login</h3>
      <input type="email" id="loginEmail" placeholder="Email"><br>
      <input type="password" id="loginPass" placeholder="Password"><br>
      <button onclick="loginUser()">Login</button>
      <p>Don't have an account? <a href="#" onclick="toggleRegister()">Register</a></p>
    </div>

    <!-- Register -->
    <div id="registerSection" class="hidden">
      <h3>Register</h3>
      <input type="email" id="regEmail" placeholder="Email"><br>
      <input type="password" id="regPass" placeholder="Password"><br>
      <input type="text" id="referralCodeInput" placeholder="Referral Code (optional)"><br>
      <button onclick="registerUser()">Register</button>
      <p>Already have an account? <a href="#" onclick="toggleRegister()">Login</a></p>
    </div>

    <!-- Game Section -->
    <div id="gameSection" class="hidden">
      <h3>Welcome, <span id="userEmail"></span></h3>
      <p>User ID: <span id="userIdDisplay"></span></p>
      <p>Balance: ‚Çπ<span id="wallet">0</span></p>
      <p>Period: <span id="periodDisplay">--</span></p>
      <p>‚è≥ Time Left: <span id="countdown">--</span></p>
      <select id="gameType">
        <option value="30">30 Sec</option>
        <option value="60" selected>1 Min</option>
        <option value="180">3 Min</option>
        <option value="300">5 Min</option>
      </select><br>
      <input type="number" id="betAmount" placeholder="Enter Bet ‚Çπ"><br>
      <div>
        <button class="btn-red" onclick="placeBet('color', 'RED')">Red</button>
        <button class="btn-green" onclick="placeBet('color', 'GREEN')">Green</button>
        <button class="btn-violet" onclick="placeBet('color', 'VIOLET')">Violet</button>
      </div>
      <div>
        <button class="btn-big" onclick="placeBet('size', 'BIG')">Big</button>
        <button class="btn-small" onclick="placeBet('size', 'SMALL')">Small</button>
      </div>
      <div>
        <p>Numbers:</p>
        <div id="numberButtons"></div>
      </div>

      <h3>My Bet History</h3>
      <table>
        <thead>
          <tr><th>Period</th><th>Type</th><th>Value</th><th>Amount</th><th>Result</th></tr>
        </thead>
        <tbody id="betHistory"></tbody>
      </table>

      <audio id="winSound" src="https://www.fesliyanstudios.com/play-mp3/387" preload="auto"></audio>
      <button onclick="logoutUser()">Logout</button>
    </div>

    <!-- Wallet Section -->
    <div id="walletSection" class="hidden">
      <h3>Wallet</h3>
      <p>Balance: ‚Çπ<span id="wallet2">0</span></p>
    </div>

    <!-- Referral Section -->
    <div id="promotionSection" class="hidden">
      <h3>Promotion</h3>
      <p>Your Referral Code: <b id="myReferralCode"></b></p>
      <p>Total Referral Earnings: ‚Çπ<span id="referralEarnings">0</span></p>
      <table>
        <thead>
          <tr><th>User</th><th>Commission</th></tr>
        </thead>
        <tbody id="referralTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="nav-bar">
    <div class="nav-btn" onclick="showSection('game')">üéÆ Game</div>
    <div class="nav-btn" onclick="showSection('wallet')">üí∞ Wallet</div>
    <div class="nav-btn" onclick="showSection('promotion')">üéÅ Promotion</div>
  </div>

  <!-- Firebase SDK and JS Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import {
      getDatabase, ref, set, update, push, get, onValue
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBe5kGOwYS3FsF_9_q1pjxaWrF1glUe87c",
      authDomain: "wingologin.firebaseapp.com",
      databaseURL: "https://wingologin-default-rtdb.firebaseio.com",
      projectId: "wingologin",
      storageBucket: "wingologin.appspot.com",
      messagingSenderId: "605536859710",
      appId: "1:605536859710:web:ed9495775c8f8dd6a8836f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let currentBalance = 0;
    let currentPeriod = null;
    let timerInterval = null;
    let userReferral = "";

    function toggleRegister() {
      document.getElementById("loginSection").classList.toggle("hidden");
      document.getElementById("registerSection").classList.toggle("hidden");
    }

    function showSection(name) {
      document.getElementById("gameSection").classList.add("hidden");
      document.getElementById("walletSection").classList.add("hidden");
      document.getElementById("promotionSection").classList.add("hidden");
      if (name === "game") document.getElementById("gameSection").classList.remove("hidden");
      if (name === "wallet") {
        document.getElementById("wallet2").innerText = currentBalance.toFixed(2);
        document.getElementById("walletSection").classList.remove("hidden");
      }
      if (name === "promotion") document.getElementById("promotionSection").classList.remove("hidden");
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("registerSection").classList.add("hidden");
        document.getElementById("gameSection").classList.remove("hidden");
        document.getElementById("userEmail").innerText = user.email;

        get(ref(db, `users/${user.uid}`)).then(snap => {
          const data = snap.val();
          currentBalance = data.balance || 0;
          document.getElementById("wallet").innerText = currentBalance.toFixed(2);
          document.getElementById("wallet2").innerText = currentBalance.toFixed(2);
          document.getElementById("userIdDisplay").innerText = data.userId;
          document.getElementById("myReferralCode").innerText = data.userId;
          userReferral = data.refBy || "";
          loadReferralEarnings();
        });

        loadUserBetHistory();
        startGame();
      }
    });
    window.loginUser = () => {
      const email = document.getElementById("loginEmail").value;
      const pass = document.getElementById("loginPass").value;
      signInWithEmailAndPassword(auth, email, pass)
        .then(() => alert("Logged in!"))
        .catch(err => alert(err.message));
    };

    window.registerUser = () => {
      const email = document.getElementById("regEmail").value;
      const pass = document.getElementById("regPass").value;
      const refCode = document.getElementById("refCode")?.value || "";
      const userId = Math.floor(100000 + Math.random() * 900000).toString();

      createUserWithEmailAndPassword(auth, email, pass).then(cred => {
        set(ref(db, `users/${cred.user.uid}`), {
          email, balance: 58, userId, refBy: refCode
        });
        alert("Registered!");
        toggleRegister();
      }).catch(err => alert(err.message));
    };

    window.logoutUser = () => signOut(auth).then(() => location.reload());

    function getCurrentPeriod(gameType, now = new Date()) {
      const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
      const secondsToday = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
      const periodIndex = Math.floor(secondsToday / gameType);
      return `${dateStr}-${String(periodIndex + 1).padStart(4, '0')}`;
    }

    function updateTimer(gameType) {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const now = new Date();
        const end = new Date(Math.ceil(Date.now() / (gameType * 1000)) * gameType * 1000);
        const diff = Math.floor((end - now) / 1000);
        currentPeriod = getCurrentPeriod(gameType, now);
        document.getElementById("countdown").innerText = diff;
        document.getElementById("periodDisplay").innerText = currentPeriod;

        if (diff <= 0) {
          clearInterval(timerInterval);
          runResult(gameType, currentPeriod);
          setTimeout(() => updateTimer(gameType), 1000);
        }
      }, 1000);
    }

    function startGame() {
      const gameType = parseInt(document.getElementById("gameType").value);
      updateTimer(gameType);
      document.getElementById("gameType").onchange = startGame;
    }

    function getColor(num) {
      if (num === 5) return "VIOLET";
      if ([1, 3, 7, 9].includes(num)) return "RED";
      return "GREEN";
    }

    function getSize(num) {
      return num >= 5 ? "BIG" : "SMALL";
    }

    function runResult(gameType, period) {
      const num = Math.floor(Math.random() * 10);
      const color = getColor(num);
      const size = getSize(num);

      set(ref(db, `results/${gameType}/${period}`), {
        number: num, color, size, timestamp: Date.now()
      });

      onValue(ref(db, `bets`), snap => {
        const allUsers = snap.val();
        if (!allUsers) return;

        Object.entries(allUsers).forEach(([uid, userBets]) => {
          const bets = userBets?.[period];
          if (!bets) return;

          let totalWin = 0;

          Object.entries(bets).forEach(([betId, bet]) => {
            let win = false;
            let multiplier = 0;

            if (bet.type === "color" && bet.value === color) {
              win = true;
              multiplier = color === "VIOLET" ? 4.5 : 1.96;
            } else if (bet.type === "size" && bet.value === size) {
              win = true;
              multiplier = 1.96;
            } else if (bet.type === "number" && Number(bet.value) === num) {
              win = true;
              multiplier = 8.5;
            }

            const payout = win ? parseFloat((bet.amount * multiplier).toFixed(2)) : 0;

            update(ref(db, `bets/${uid}/${period}/${betId}`), {
              win: win, payout: payout
            });

            if (uid === currentUser.uid && win) {
              totalWin += payout;
            }
          });

          if (totalWin > 0) {
            get(ref(db, `users/${uid}`)).then(snap => {
              const userData = snap.val();
              const newBalance = (userData.balance || 0) + totalWin;
              update(ref(db, `users/${uid}`), { balance: newBalance });
              if (uid === currentUser.uid) {
                currentBalance = newBalance;
                document.getElementById("wallet").innerText = newBalance.toFixed(2);
                document.getElementById("wallet2").innerText = newBalance.toFixed(2);
                document.getElementById("winSound").play();
                alert(`üéâ You won ‚Çπ${totalWin.toFixed(2)} this round!`);
              }
            });
          }
        });
      }, { onlyOnce: true });
    }

    window.placeBet = (type, value) => {
      const amount = parseFloat(document.getElementById("betAmount").value);
      if (!amount || amount <= 0) return alert("Enter valid amount");
      if (amount > currentBalance) return alert("Insufficient balance");

      const betRef = ref(db, `bets/${currentUser.uid}/${currentPeriod}`);
      const newBet = { type, value, amount, win: null };
      push(betRef, newBet);

      currentBalance -= amount;
      update(ref(db, `users/${currentUser.uid}`), { balance: currentBalance });
      document.getElementById("wallet").innerText = currentBalance.toFixed(2);
      document.getElementById("wallet2").innerText = currentBalance.toFixed(2);

      const row = `<tr><td>${currentPeriod}</td><td>${type}</td><td>${value}</td><td>${amount}</td><td>Pending</td></tr>`;
      document.getElementById("betHistory").innerHTML += row;

      // Save referral commission (0.06%) for next day
      if (userReferral) {
        const comm = parseFloat((amount * 0.0006).toFixed(4));
        const today = new Date();
        today.setDate(today.getDate() + 1);
        today.setHours(1, 0, 0, 0);
        const payoutKey = today.toISOString().split("T")[0];
        const refPath = `referralCommissions/${userReferral}/${payoutKey}`;
        get(ref(db, refPath)).then(snap => {
          const current = snap.val() || 0;
          update(ref(db), { [refPath]: current + comm });
        });
      }
    };

    function loadUserBetHistory() {
      onValue(ref(db, `bets/${auth.currentUser.uid}`), snap => {
        const data = snap.val();
        document.getElementById("betHistory").innerHTML = "";
        if (!data) return;
        Object.entries(data).forEach(([period, bets]) => {
          Object.values(bets).forEach(bet => {
            const row = `<tr><td>${period}</td><td>${bet.type}</td><td>${bet.value}</td><td>${bet.amount}</td><td>${bet.win === null ? "Pending" : bet.win ? '‚úÖ' : '‚ùå'}</td></tr>`;
            document.getElementById("betHistory").innerHTML += row;
          });
        });
      });
    }

    function loadReferralEarnings() {
      const refTable = document.getElementById("referralTable");
      refTable.innerHTML = "";
      let totalEarned = 0;
      onValue(ref(db, `referralCommissions/${currentUser.uid}`), snap => {
        const data = snap.val();
        if (!data) return;
        Object.entries(data).forEach(([date, amount]) => {
          totalEarned += amount;
          const row = `<tr><td>${date}</td><td>‚Çπ${amount.toFixed(4)}</td></tr>`;
          refTable.innerHTML += row;
        });
        document.getElementById("referralEarnings").innerText = totalEarned.toFixed(4);
      });
    }

    for (let i = 0; i <= 9; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className = "number-btn";
      btn.onclick = () => placeBet("number", i);
      document.getElementById("numberButtons").appendChild(btn);
    }
  </script>
</body>
</html>
