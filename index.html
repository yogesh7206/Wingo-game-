<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Win89 Merged Dashboard</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f8f9fa; }
header { background: #007bff; padding: 10px; color: #fff; text-align: center; font-size: 20px; font-weight: bold; }
nav { background: #fff; border-top: 1px solid #ccc; position: fixed; bottom: 0; left: 0; width: 100%; display: flex; justify-content: space-around; padding: 5px 0; z-index: 1000;}
nav button { background: none; border: none; font-size: 14px; color: #333; display:flex; flex-direction:column; align-items:center; }
nav button span { font-size:18px; }
.section { display: none; padding: 15px; }
.active-section { display: block !important; }
.account-stats { display: flex; justify-content: space-around; flex-wrap: wrap; background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
.stat { text-align: center; flex: 1 1 45%; margin: 5px 0; }
.stat h3 { color: #004085; margin: 0; font-size: 18px; }
.stat p { color: #6c757d; font-size: 14px; margin: 0; }
.action-buttons { display: flex; justify-content: space-around; margin-top: 10px; }
.action-buttons button { flex: 1; margin: 5px; padding: 12px; border: none; border-radius: 25px; font-size: 16px; color: #fff; }
.recharge-btn { background: linear-gradient(45deg, #ffc107, #ffb300); }
.withdraw-btn { background: linear-gradient(45deg, #28a745, #218838); }
.menu-list{margin:15px 0;background:#fff;border-radius:12px;overflow:hidden}
.menu-item{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid #eceff1; cursor:pointer;}
.menu-item:last-child{border-bottom:none}
.menu-item.active,.menu-item:hover{background:#e9f1fc;}
.menu-icon{font-size:20px;width:24px;text-align:center}
.menu-text{flex:1;font-size:15px;color:#212529}
.menu-arrow{color:#9aa0a6}
.profile-avatar {width:68px; height:68px; border-radius:50%; object-fit:cover;}
.user-info-top {background:#f6f6f8; border-radius:16px; display:flex; align-items:center; gap:18px; padding:18px 14px 16px 14px; margin-bottom:15px;}
.user-contact {font-size:18px; font-weight:bold; color:#111; margin-bottom:6px;}
.invite-code-box { background:#fff;font-size:16px;padding:4px 14px; border-radius:12px;display:inline-block;letter-spacing:1.2px; color:#157efb; font-weight:500; border:1px solid #e0e6ed;}
.copy-icon {cursor:pointer; font-size:19px; margin-left:5px;}
.logout-btn-big {
    display: block;
    width: 94%;
    margin: 28px auto 18px auto;
    padding: 18px 0;
    font-size: 20px;
    font-weight: bold;
    border: none;
    border-radius: 18px;
    background: linear-gradient(90deg, #157efb 0%, #4bb2ff 100%);
    color: #fff;
    box-shadow: 0 1px 7px #1561c340;
    transition: background 0.2s;
    cursor: pointer;
}
.logout-btn-big:hover {
    background: linear-gradient(90deg, #1561c3 0%, #2891ec 100%);
}
.page-content{max-width:440px;margin:35px auto;padding:23px 16px 24px 16px;background:#fff;border-radius:16px;box-shadow:0 1px 8px #ddeaff;}
.page-content h2{margin-top:0;}
.page-content label{font-weight:bold;margin-top:12px;display:block;}
.page-content input, .page-content select {width:100%;margin:6px 0 18px 0; padding:8px; border-radius:6px; border:1px solid #ccc;}
.page-content button, .page-content .btn {padding:10px 18px;background:#157efb;color:#fff;border:none;border-radius:7px;font-size:16px; font-weight:bold;}
.page-content table{width:100%;border-collapse:collapse;}
.page-content th, .page-content td{border:1px solid #eee;padding:8px;}
.page-content th{background:#157efb;color:#fff;}
.page-content td{background:#f8fafd;}
.modal-overlay {display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.32);z-index:900;}
.modal-box {background:#fff;max-width:340px;margin:70px auto 0 auto;padding:28px 20px 20px 20px;border-radius:16px;box-shadow:0 1px 16px #a3c2ff;position:relative;}
.modal-box h2 {margin-top:0;}
.modal-box label {font-weight:bold;}
.modal-box input, .modal-box select {width:100%;margin-bottom:12px;padding:8px;border-radius:6px;border:1px solid #ccc;}
.modal-box button {width:100%;padding:12px 0;font-size:16px;background:#157efb;color:#fff;border:none;border-radius:9px;font-weight:bold;}
.modal-box .close-modal {position:absolute;right:18px;top:10px;font-size:24px;cursor:pointer;color:#157efb;}
.modal-box .withdraw-btn {background:#28a745;}
</style>
</head>
<body>
<header>Win89</header>
<nav id="bottomNav">
    <button onclick="showSection('homeSection')"><span>üè†</span>Home</button>
    <button onclick="showSection('investmentSection')"><span>üí∞</span>Investment</button>
    <button onclick="showSection('blogSection')"><span>üìù</span>Blog</button>
    <button onclick="showSection('noticeSection')"><span>üì¢</span>Notice</button>
    <button onclick="showSection('accountSection')"><span>üë§</span>Account</button>
</nav>
<div id="loginSection" class="section active-section">
    <h2>Login</h2>
    <input type="email" id="loginEmail" placeholder="Email"><br><br>
    <input type="password" id="loginPassword" placeholder="Password"><br><br>
    <button onclick="loginUser()">Login</button>
    <p>Don't have an account? <a href="#" onclick="showSection('registerSection')">Register</a></p>
</div>
<div id="registerSection" class="section">
    <h2>Register</h2>
    <input type="email" id="registerEmail" placeholder="Email"><br><br>
    <input type="password" id="registerPassword" placeholder="Password"><br><br>
    <input type="text" id="registerReferral" placeholder="Referral Code (if any)"><br><br>
    <button onclick="registerUser()">Register</button>
    <p>Already have an account? <a href="#" onclick="showSection('loginSection')">Login</a></p>
</div>
<div id="homeSection" class="section">
    <h2>Home</h2>
    <p>Welcome to Win89!</p>
</div>
<div id="investmentSection" class="section">
  <h2>Investment</h2>
  <div id="productList" style="max-width:400px;margin:auto;">
    <div style="background:#fff;padding:20px 16px;border-radius:12px;box-shadow:0 2px 6px #e1edff;margin-bottom:18px;">
      <h3 style="margin:0 0 10px 0;">VIP 1</h3>
      <p style="margin:0 0 8px 0;"><strong>Buy Price:</strong> ‚Çπ290</p>
      <ul style="margin:0 0 12px 16px;padding:0;list-style:square;">
        <li><strong>Time Period:</strong> 47 days</li>
        <li><strong>Daily Earning:</strong> ‚Çπ234</li>
        <li><strong>Total Earnings:</strong> ‚Çπ11,040</li>
      </ul>
      <button id="vip1InvestBtn" style="padding:10px 24px;background:#157efb;color:#fff;border:none;border-radius:7px;font-size:16px;font-weight:bold;">Invest Now</button>
      <div id="vip1InvestError" style="color:red;font-size:15px;margin-top:10px;display:none;"></div>
    </div>
  </div>
</div>
<div id="blogSection" class="section">
    <h2>Blog</h2>
    <p>Latest blog posts.</p>
</div>
<div id="noticeSection" class="section">
    <h2>Notice</h2>
    <p>Important updates.</p>
</div>
<div id="accountSection" class="section">
    <h2>My Account</h2>
    <div class="user-info-top">
        <img id="userAvatar" class="profile-avatar" src="https://ui-avatars.com/api/?name=User&rounded=true&background=4bb2ff&color=fff&size=96" alt="avatar">
        <div style="flex:1;">
            <div id="userContact" class="user-contact">MOBILE: -</div>
            <div style="display:flex;align-items:center;gap:7px;">
                <span class="invite-code-box">
                    User ID: <span id="userIdBox">------</span>
                </span>
                <span class="copy-icon" title="Copy" onclick="copyUserId()">üìã</span>
            </div>
        </div>
    </div>
    <div class="account-stats">
        <div class="stat">
            <h3 id="balance">‚Çπ0</h3>
            <p>Balance</p>
        </div>
        <div class="stat">
            <h3 id="recharge">‚Çπ0</h3>
            <p>Recharge</p>
        </div>
        <div class="stat">
            <h3 id="withdrawal">‚Çπ0</h3>
            <p>Withdrawal</p>
        </div>
        <div class="stat">
            <h3 id="productRevenue">‚Çπ0</h3>
            <p>Product revenue</p>
        </div>
        <div class="stat">
            <h3 id="myOrders">0</h3>
            <p>My Orders</p>
        </div>
    </div>
    <div class="action-buttons">
        <button class="recharge-btn" onclick="openRecharge()">Recharge</button>
        <button class="withdraw-btn" onclick="openWithdrawal()">Withdrawal</button>
    </div>
    <br>
    <div class="menu-list" id="submenuList"></div>
    <button class="logout-btn-big" onclick="logoutUser();">Logout</button>
</div>
<div id="rechargeModal" class="modal-overlay">
  <div class="modal-box">
    <span class="close-modal" onclick="closeRecharge()">√ó</span>
    <h2>Recharge</h2>
    <form onsubmit="submitRecharge(event)">
      <label>Amount</label>
      <input id="rechargeAmount" type="number" min="1" required placeholder="Enter amount">
      <label>Payment Method</label>
      <select id="rechargeMethod" required>
        <option value="">Select</option>
        <option value="UPI">UPI</option>
        <option value="Card">Debit/Credit Card</option>
        <option value="NetBanking">Net Banking</option>
      </select>
      <button type="submit">Recharge Now</button>
    </form>
  </div>
</div>
<div id="withdrawalModal" class="modal-overlay">
  <div class="modal-box">
    <span class="close-modal" onclick="closeWithdrawal()">√ó</span>
    <h2>Withdrawal</h2>
    <form onsubmit="submitWithdrawal(event)">
      <label>Amount</label>
      <input id="withdrawalAmount" type="number" min="1" required placeholder="Enter amount">
      <label>Bank Account / UPI ID</label>
      <input id="withdrawalBank" type="text" required placeholder="Enter Bank/UPI ID">
      <button type="submit" class="withdraw-btn">Withdraw</button>
    </form>
  </div>
</div>
<div id="bankCardPage" class="section">
  <div class="page-content">
    <h2>Bank Card Details</h2>
    <form id="bankCardForm" onsubmit="saveBankDetails(event)">
      <label>Account Holder Name</label>
      <input type="text" id="accountHolder" placeholder="Enter account holder name" required>
      <label>Card Number</label>
      <input type="text" id="cardNumber" placeholder="Enter card number" required>
      <label>Bank Name</label>
      <input type="text" id="bankName" placeholder="Enter bank name" required>
      <label>IFSC Code</label>
      <input type="text" id="ifscCode" placeholder="Enter IFSC code" required>
      <button type="submit" id="saveBankBtn">Save Card</button>
      <button type="button" id="editBankBtn" style="display:none;margin-top:10px;" onclick="enableEditBank()">Edit</button>
    </form>
  </div>
</div>
<div id="transactionsPage" class="section">
  <div class="page-content">
    <h2>Recent Transactions</h2>
    <table>
      <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Status</th></tr></thead>
      <tbody id="transactionsBody"></tbody>
    </table>
  </div>
</div>
<div id="myProductPage" class="section">
  <div class="page-content">
    <h2>My Products</h2>
    <div id="userProducts"></div>
  </div>
</div>
<div id="myTeamPage" class="section">
  <div class="page-content">
    <h2>My Team</h2>
    <div id="teamStats" style="display:grid;gap:8px 18px;grid-template-columns:1fr 1fr;margin-bottom:15px;">
      <div><strong>Total Invites:</strong> <span id="totalInvites">0</span></div>
      <div><strong>Today Invites:</strong> <span id="todayInvites">0</span></div>
      <div><strong>Today Commission:</strong> ‚Çπ<span id="todayCommission">0</span></div>
      <div><strong>Yesterday Commission:</strong> ‚Çπ<span id="yesterdayCommission">0</span></div>
    </div>
    <button class="btn">Invite New Member</button>
    <p style="margin-top:18px;margin-bottom:8px;">Share your referral link:</p>
    <div style="display:flex;align-items:center;gap:8px;">
      <input id="referralLink" type="text" readonly style="flex:1; padding:6px 10px; font-size:15px; border:1px solid #bcd6f1; border-radius:6px;">
      <button class="btn" style="padding:6px 10px; font-size:15px;" onclick="copyReferral()">Copy</button>
    </div>
    <small style="color:#157efb;margin-top:5px;display:block;">Invite friends using your referral link above.</small>
    <ul style="margin-top:16px;">
      <li>Team Member 1</li>
      <li>Team Member 2</li>
    </ul>
  </div>
</div>
<div id="customerServicePage" class="section">
  <div class="page-content">
    <h2>Customer Service</h2>
    <p>Contact us at <b>support@win89.com</b></p>
    <button class="btn" onclick="window.open('https://t.me/YourTelegramGroupLink','_blank')">Open Telegram</button>
  </div>
</div>
<div id="resetPasswordPage" class="section">
  <div class="page-content">
    <h2>Reset Password</h2>
    <form>
      <label>Old Password</label>
      <input type="password" placeholder="Enter old password" required>
      <label>New Password</label>
      <input type="password" placeholder="Enter new password" required>
      <button type="submit">Reset Password</button>
    </form>
  </div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDvF1KrDDRZJucp-78dbvmQ34Oi3j17Rrk",
  authDomain: "investment-website-deml.firebaseapp.com",
  projectId: "investment-website-deml",
  storageBucket: "investment-website-deml.firebasestorage.app",
  messagingSenderId: "814451995593",
  appId: "1:814451995593:web:55e3280d9cb43200f1ee18",
  measurementId: "G-8FKZE5NNSX"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
</script>
<!-- Part 3 = all main JS logic -->
    <script>
// Helper to add a transaction record to Firestore for current user
async function addTransaction(userId, type, amount, status) {
  const now = new Date();
  const userTransRef = db.collection('users').doc(userId).collection('transactions');
  await userTransRef.add({
    date: now,
    type: type,
    amount: amount,
    status: status
  });
}

function showSection(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active-section'));
  var el = document.getElementById(id);
  if(el) el.classList.add('active-section');
}
function copyUserId() {
    var code = document.getElementById('userIdBox').innerText;
    navigator.clipboard.writeText(code);
    alert('User ID copied!');
}
function updateReferralLink() {
    var code = document.getElementById("userIdBox").innerText;
    var link = "https://yogesh7206.github.io/Wingo-game-/#?ref=" + encodeURIComponent(code);
    document.getElementById("referralLink").value = link;
}
function copyReferral() {
    var val = document.getElementById("referralLink").value;
    navigator.clipboard.writeText(val);
    alert("Referral link copied!");
}
function openRecharge() { document.getElementById('rechargeModal').style.display = 'block'; }
function closeRecharge() { document.getElementById('rechargeModal').style.display = 'none'; }
function openWithdrawal() { document.getElementById('withdrawalModal').style.display = 'block'; }
function closeWithdrawal() { document.getElementById('withdrawalModal').style.display = 'none'; }
function submitRecharge(e){
  e.preventDefault();
  var amt = document.getElementById("rechargeAmount").value;
  var method = document.getElementById("rechargeMethod").value;
  if(Number(amt)<1 || !method){ alert("Enter valid amount and payment method."); return;}
  alert("Recharge of ‚Çπ"+amt+" by "+method+" submitted!");
  closeRecharge();
  document.getElementById("rechargeAmount").value="";
  document.getElementById("rechargeMethod").value="";
}
function submitWithdrawal(e){
  e.preventDefault();
  var amt = document.getElementById("withdrawalAmount").value;
  var bank = document.getElementById("withdrawalBank").value;
  if(Number(amt)<1 || !bank){ alert("Enter valid amount and bank/UPI details."); return;}
  alert("Withdrawal of ‚Çπ"+amt+" to "+bank+" submitted!");
  closeWithdrawal();
  document.getElementById("withdrawalAmount").value="";
  document.getElementById("withdrawalBank").value="";
}
// -------- Bank details logic --------
function loadBankDetails() {
  auth.onAuthStateChanged(async (user) => {
    if (!user) return;
    const userRef = db.collection('users').doc(user.uid);
    const doc = await userRef.get();
    const d = doc.data() || {};
    document.getElementById('accountHolder').value = d.accountHolder || '';
    document.getElementById('cardNumber').value = d.cardNumber || '';
    document.getElementById('bankName').value = d.bankName || '';
    document.getElementById('ifscCode').value = d.ifscCode || '';
    Array.from(document.querySelectorAll("#bankCardForm input")).forEach(inp => inp.readOnly = true);
    document.getElementById("saveBankBtn").style.display = "none";
    document.getElementById("editBankBtn").style.display = "inline-block";
  });
}
async function saveBankDetails(event) {
  event.preventDefault();
  const accountHolder = document.getElementById('accountHolder').value.trim();
  const cardNumber = document.getElementById('cardNumber').value.trim();
  const bankName = document.getElementById('bankName').value.trim();
  const ifscCode = document.getElementById('ifscCode').value.trim();
  if (!accountHolder || !cardNumber || !bankName || !ifscCode) {
    alert("All fields required."); return;
  }
  const user = auth.currentUser;
  if (!user) { alert("Not logged in."); return; }
  await db.collection('users').doc(user.uid).update({
    accountHolder, cardNumber, bankName, ifscCode
  });
  alert("Bank details saved!");
  loadBankDetails();
}
function enableEditBank() {
  Array.from(document.querySelectorAll("#bankCardForm input")).forEach(inp => inp.readOnly = false);
  document.getElementById("saveBankBtn").style.display = "inline-block";
  document.getElementById("editBankBtn").style.display = "none";
}
(function(){
  let oldShowSection = window.showSection;
  window.showSection = function(id) {
    oldShowSection(id);
    if(id === "bankCardPage") loadBankDetails();
    if(id === "myProductPage") showUserProducts();
    if(id === "investmentSection" && typeof loadBalance === "function") loadBalance();
    if(id === "transactionsPage") showTransactions();
  };
})();
// ---- Investment logic: Buy Product, Daily Claim ----
document.addEventListener("DOMContentLoaded", function() {
  var investBtn = document.getElementById('vip1InvestBtn');
  if (investBtn) {
    investBtn.onclick = async function() {
      const user = auth.currentUser;
      if (!user) { alert('Please login.'); return; }
      const userRef = db.collection('users').doc(user.uid);
      const doc = await userRef.get();
      const data = doc.data();
      const userBalance = data.balance || 0;
      const price = 290;
      if (userBalance < price) {
        document.getElementById('vip1InvestError').innerText = "Insufficient balance.";
        document.getElementById('vip1InvestError').style.display = "";
        return;
      }
      // Check if already purchased!
      const productsRef = db.collection('users').doc(user.uid).collection('products');
      const has = await productsRef.where("productName", "==", "VIP 1").get();
      if (!has.empty) {
        document.getElementById('vip1InvestError').innerText = "You have already purchased VIP 1.";
        document.getElementById('vip1InvestError').style.display = "";
        return;
      }
      // Deduct money, add product, add transaction
      await userRef.update({ balance: userBalance - price });
      await addTransaction(user.uid, "Product Purchase: VIP 1", -price, "Success");
      await productsRef.add({
        productName: 'VIP 1',
        buyPrice: price,
        days: 47,
        dailyEarning: 234,
        totalEarning: 11040,
        purchaseDate: new Date(),
        claimedDays: 0,
        lastClaimDate: null
      });
      alert('Product purchased successfully!');
      document.getElementById('vip1InvestError').style.display = "none";
      showUserProducts();
    };
  }
});
async function showUserProducts() {
  const user = auth.currentUser;
  if (!user) return;
  const productsRef = db.collection('users').doc(user.uid).collection('products');
  const snap = await productsRef.get();
  let html = "";
  if (snap.empty) {
    html = "<p>You have no active products.</p>";
  } else {
    snap.forEach(doc => {
      const d = doc.data();
      const today = new Date();
      today.setHours(0,0,0,0);
      let claimButton = "";
      let claimedMsg = "";
      let canClaim = false;
      if ((d.claimedDays || 0) >= d.days) {
        claimButton = '<span style="color:green;">Completed</span>';
      } else {
        let lastClaim = d.lastClaimDate && d.lastClaimDate.toDate ? d.lastClaimDate.toDate() : (d.lastClaimDate ? new Date(d.lastClaimDate) : null);
        let alreadyClaimed =  lastClaim && new Date(lastClaim).setHours(0,0,0,0) === today.getTime();
        if (alreadyClaimed) {
          claimedMsg = '<span style="color:green;">Already claimed for today.</span>';
        } else {
          canClaim = true;
          claimButton = '<button onclick="claimDailyEarning(\''+doc.id+'\')" style=\'margin-top:7px;background:#28a745;color:#fff;padding:7px 18px;border-radius:5px;border:none;font-weight:bold;\'>Claim Today\'s ‚Çπ'+d.dailyEarning+'</button>';
        }
      }
      html += `<div style="background:#f4f7ff;padding:13px 11px 12px 13px;margin-bottom:13px;border-radius:10px;">
          <strong>${d.productName}</strong><br>
          <span>Days: ${d.days}, Claimed: ${d.claimedDays||0}/${d.days}</span><br>
          <span style="font-size:15px;">Daily: ‚Çπ${d.dailyEarning} | Total: ‚Çπ${d.totalEarning}</span><br>
          ${claimButton} ${claimedMsg}
        </div>`;
    });
  }
  document.getElementById('userProducts').innerHTML = html;
}
window.showUserProducts = showUserProducts;
window.claimDailyEarning = async function(productId) {
  const user = auth.currentUser;
  if (!user) return;
  const userRef = db.collection('users').doc(user.uid);
  const productRef = userRef.collection('products').doc(productId);
  const productDoc = await productRef.get();
  const d = productDoc.data();
  if (!d) return;
  const now = new Date();
  now.setHours(0,0,0,0);
  let lastClaim = d.lastClaimDate && d.lastClaimDate.toDate ? d.lastClaimDate.toDate() : (d.lastClaimDate ? new Date(d.lastClaimDate) : null);
  if (lastClaim && new Date(lastClaim).setHours(0,0,0,0) === now.getTime()) {
    alert("You have already claimed today's earning.");
    return;
  }
  await productRef.update({
    claimedDays: (d.claimedDays || 0)+1,
    lastClaimDate: new Date()
  });
  const userSnap = await userRef.get();
  const balance = userSnap.data().balance || 0;
  await userRef.update({ balance: balance + d.dailyEarning });
  await addTransaction(user.uid, "Product Earning Claim: VIP 1", d.dailyEarning, "Success");
  const prevRevenue = userSnap.data().productRevenue || 0;
  await userRef.update({ productRevenue: prevRevenue + d.dailyEarning });
  alert(`You have claimed ‚Çπ${d.dailyEarning} today!`);
  showUserProducts();
};
// Transaction history display
async function showTransactions() {
  const user = auth.currentUser;
  if (!user) return;
  const ref = db.collection('users').doc(user.uid).collection('transactions').orderBy("date", "desc").limit(20);
  const snap = await ref.get();
  let html = "";
  if (snap.empty) {
    html = "<tr><td colspan='4'>No transactions yet.</td></tr>";
  } else {
    snap.forEach(doc => {
      const d = doc.data();
      const dt = d.date && d.date.toDate ? d.date.toDate() : new Date(d.date);
      const showDate = dt.toLocaleDateString()+" "+dt.toLocaleTimeString();
      html += `<tr>
        <td>${showDate}</td>
        <td>${d.type}</td>
        <td>${d.amount>=0 ? "+" : ""}${d.amount}</td>
        <td>${d.status}</td>
      </tr>`;
    });
  }
  document.getElementById("transactionsBody").innerHTML = html;
}
window.showTransactions = showTransactions;

// --- User doc initialization/registration/updating ---
auth.onAuthStateChanged(async (user) => {
  const nav = document.getElementById('bottomNav');
  if (!user) {
    nav.style.display = 'none';
    showSection('loginSection');
    return;
  }
  nav.style.display = 'flex';
  showSection('homeSection');
  const UID = user.uid;
  const userRef = db.collection('users').doc(UID);
  const snap = await userRef.get();
  let userIdVal = null;
  if (!snap.exists || Object.keys(snap.data()||{}).length===0) {
    userIdVal = String(Math.floor(100000 + Math.random() * 900000));
    await userRef.set({
      userId: userIdVal,
      balance:0, rechargeTotal:0, withdrawalTotal:0, productRevenue:0, orders:0,
      email: user.email,
      mobile: '',
      referredBy: "",
      totalInvites: 0,
      todayInvites: 0,
      todayCommission: 0,
      yesterdayCommission: 0,
      accountHolder: "",
      cardNumber: "",
      bankName: "",
      ifscCode: ""
    });
  } else {
    const data = snap.data();
    const updates = {};
    if (!data.userId) {
      userIdVal = String(Math.floor(100000 + Math.random() * 900000));
      updates.userId = userIdVal;
    }
    if (!data.email) updates.email = user.email;
    if (Object.keys(updates).length > 0) await userRef.update(updates);
  }
  userRef.onSnapshot(doc => {
    const d = doc.data() || {};
    document.getElementById('balance').textContent = '‚Çπ'+(d.balance||0);
    document.getElementById('recharge').textContent = '‚Çπ'+(d.rechargeTotal||0);
    document.getElementById('withdrawal').textContent = '‚Çπ'+(d.withdrawalTotal||0);
    document.getElementById('productRevenue').textContent = '‚Çπ'+(d.productRevenue||0);
    document.getElementById('myOrders').textContent = d.orders||0;
    document.getElementById('userContact').textContent = d.mobile 
        ? `MOBILE: ${d.mobile}` 
        : (d.email ? `EMAIL: ${d.email}` : '-');
    document.getElementById('userIdBox').textContent = d.userId || '------';
    updateReferralLink();
    if(d.avatarUrl) document.getElementById('userAvatar').src = d.avatarUrl;
    document.getElementById('totalInvites').textContent = d.totalInvites || 0;
    document.getElementById('todayInvites').textContent = d.todayInvites || 0;
    document.getElementById('todayCommission').textContent = d.todayCommission || 0;
    document.getElementById('yesterdayCommission').textContent = d.yesterdayCommission || 0;
  });
});
async function loginUser(){
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPassword').value.trim();
  if(!email || !pass){ alert('Enter email & password'); return; }
  try{ await auth.signInWithEmailAndPassword(email, pass); }
  catch(e){ alert(e.message); if(e.code==='auth/user-not-found') showSection('registerSection'); }
}
async function registerUser(){
  const email = document.getElementById('registerEmail').value.trim();
  const pass = document.getElementById('registerPassword').value.trim();
  const referral = document.getElementById('registerReferral').value.trim();
  if(!email || !pass){ alert('Enter email & password'); return; }
  const userIdVal = String(Math.floor(100000 + Math.random()*900000));
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await db.collection('users').doc(cred.user.uid).set({
      userId: userIdVal,
      balance:0, rechargeTotal:0, withdrawalTotal:0, productRevenue:0, orders:0,
      email,
      mobile: '',
      referredBy: referral || "",
      totalInvites: 0,
      todayInvites: 0,
      todayCommission: 0,
      yesterdayCommission: 0,
      accountHolder: "",
      cardNumber: "",
      bankName: "",
      ifscCode: ""
    });
    if(referral){
      const supervisorSnap = await db.collection('users').where("userId", "==", referral).limit(1).get();
      if(!supervisorSnap.empty){
        const supervisorDoc = supervisorSnap.docs[0];
        await db.runTransaction(async (transaction) => {
          const docRef = db.collection('users').doc(supervisorDoc.id);
          const doc = await transaction.get(docRef);
          const data = doc.data();
          transaction.update(docRef, {
            totalInvites: (data.totalInvites || 0) + 1,
            todayInvites: (data.todayInvites || 0) + 1
          });
        });
      }
    }
    alert('Registered! Please login.');
    showSection('loginSection');
  }catch(e){ alert(e.message); }
}
function logoutUser(){ auth.signOut(); }
(function(){
  const menuData = [
    { id:"bankCardPage", icon:"üè¶", text:"Bank Card" },
    { id:"transactionsPage", icon:"üßæ", text:"Transactions" },
    { id:"myProductPage", icon:"üì¶", text:"My Product" },
    { id:"myTeamPage", icon:"üë•", text:"My Team" },
    { id:"customerServicePage", icon:"üí¨", text:"Customer Service" },
    { id:null, icon:"üì¢", text:"Telegram Group", url:"https://t.me/YourTelegramGroupLink" },
    { id:"resetPasswordPage", icon:"üîí", text:"Reset Password" }
  ];
  const wrap = document.getElementById('submenuList');
  wrap.innerHTML = menuData.map(item =>
    `<div class="menu-item" tabindex="0">
      <span class="menu-icon">${item.icon}</span>
      <span class="menu-text">${item.text}</span>
      <span class="menu-arrow">‚Ä∫</span>
    </div>`
  ).join('');
  Array.from(wrap.querySelectorAll('.menu-item')).forEach((item, i) => {
    item.onclick = function() {
      if(menuData[i].url) {
        window.open(menuData[i].url, "_blank");
      } else if(menuData[i].id) {
        showSection(menuData[i].id);
      }
    }
  });
})();
// --- Auto-fill referral code from ?ref=... in hash or search and auto-open registration page ---
window.addEventListener("DOMContentLoaded", function () {
  function getRefCode() {
    let hash = window.location.hash;
    let m = hash && hash.match(/[?&]ref=([0-9]{6,})/);
    if (m) return m[1];
    let params = new URLSearchParams(window.location.search);
    if (params.has("ref")) return params.get("ref");
    return "";
  }
  var refCode = getRefCode();
  if (refCode) {
    var refInput = document.getElementById("registerReferral");
    if (refInput) refInput.value = refCode;
    showSection('registerSection');
  }
});
function loadBalance(){}
</script>
</body>
</html>
