<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wingo Game</title>
  <style>
    body { font-family: Arial; background: #eef2f7; margin: 0; padding: 10px; text-align: center; }
    .hidden { display: none; }
    input, button, select { padding: 10px; margin: 5px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
    .btn-red { background: #e53935; color: white; }
    .btn-green { background: #43a047; color: white; }
    .btn-violet { background: #8e24aa; color: white; }
    .btn-big, .btn-small { background: #ff9800; color: white; }
    .number-btn {
      background: #3949ab; color: white; margin: 2px;
      border-radius: 50%; width: 40px; height: 40px; border: none;
    }
    table { width: 100%; margin-top: 10px; border-collapse: collapse; background: #fff; }
    th, td { padding: 6px; border: 1px solid #ddd; font-size: 14px; }
    th { background: #1976d2; color: white; }
    audio { display: none; }
    .section { border: 1px solid #ccc; padding: 10px; margin-top: 10px; background: #fff; }
  </style>
</head>
<body>

<div id="loginSection">
  <h2>Login</h2>
  <input type="email" id="loginEmail" placeholder="Email"><br>
  <input type="password" id="loginPass" placeholder="Password"><br>
  <button onclick="loginUser()">Login</button>
  <p>No account? <a href="#" onclick="toggleRegister()">Register</a></p>
</div>

<div id="registerSection" class="hidden">
  <h2>Register</h2>
  <input type="email" id="regEmail" placeholder="Email"><br>
  <input type="password" id="regPass" placeholder="Password"><br>
  <input type="text" id="refCode" placeholder="Referral Code (optional)"><br>
  <button onclick="registerUser()">Register</button>
  <p>Already have an account? <a href="#" onclick="toggleRegister()">Login</a></p>
</div>

<div id="gameSection" class="hidden">
  <h2>Welcome, <span id="userEmail"></span></h2>
  <p>User ID: <span id="userIdDisplay"></span></p>
  <p>Balance: ₹<span id="wallet">0</span></p>
  <p>Referral Code: <span id="referralCodeShow"></span></p>
  <p>Total Commission Earned: ₹<span id="refEarnings">0</span></p>
  <p>Period: <span id="periodDisplay">--</span> ⏳ <span id="countdown">--</span></p>
  <select id="gameType">
    <option value="30">30s</option>
    <option value="60" selected>1m</option>
    <option value="180">3m</option>
    <option value="300">5m</option>
  </select><br>
  <input type="number" id="betAmount" placeholder="Enter Bet ₹"><br>
  <button class="btn-red" onclick="placeBet('color', 'RED')">Red</button>
  <button class="btn-green" onclick="placeBet('color', 'GREEN')">Green</button>
  <button class="btn-violet" onclick="placeBet('color', 'VIOLET')">Violet</button><br>
  <button class="btn-big" onclick="placeBet('size', 'BIG')">Big</button>
  <button class="btn-small" onclick="placeBet('size', 'SMALL')">Small</button><br>
  <div id="numberButtons"></div>
  <button onclick="logoutUser()">Logout</button>

  <div class="section">
    <h3>My Bet History</h3>
    <table>
      <thead><tr><th>Period</th><th>Type</th><th>Value</th><th>Amount</th><th>Result</th></tr></thead>
      <tbody id="betHistory"></tbody>
    </table>
  </div>
</div>

<audio id="winSound" src="https://www.fesliyanstudios.com/play-mp3/387" preload="auto"></audio>

<script type="module">
// Import Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
import { getDatabase, ref, set, push, update, get, onValue } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBe5kGOwYS3FsF_9_q1pjxaWrF1glUe87c",
  authDomain: "wingologin.firebaseapp.com",
  databaseURL: "https://wingologin-default-rtdb.firebaseio.com",
  projectId: "wingologin",
  storageBucket: "wingologin.appspot.com",
  messagingSenderId: "605536859710",
  appId: "1:605536859710:web:ed9495775c8f8dd6a8836f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
let currentUser = null;
let currentBalance = 0;
let currentPeriod = null;
let refCode = null;

// Auth state
onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    document.getElementById("loginSection").classList.add("hidden");
    document.getElementById("registerSection").classList.add("hidden");
    document.getElementById("gameSection").classList.remove("hidden");
    document.getElementById("userEmail").innerText = user.email;
    loadProfile();
    loadBetHistory();
    startGame();
  }
});

// Register
window.registerUser = () => {
  const email = document.getElementById("regEmail").value;
  const pass = document.getElementById("regPass").value;
  const refInput = document.getElementById("refCode").value.trim();
  const uidCode = Math.floor(100000 + Math.random() * 900000).toString();
  createUserWithEmailAndPassword(auth, email, pass).then(cred => {
    set(ref(db, "users/" + cred.user.uid), {
      email: email,
      balance: 58,
      userId: uidCode,
      referral: refInput || "",
      refEarnings: 0
    });
    if (refInput) {
      get(ref(db, "users")).then(snap => {
        Object.entries(snap.val() || {}).forEach(([uid, u]) => {
          if (u.userId === refInput) {
            push(ref(db, `commissionLogs/${uid}`), {
              from: email,
              date: new Date().toISOString().slice(0,10),
              amount: 0 // Add later after betting
            });
          }
        });
      });
    }
    alert("Registered! ₹58 added.");
  });
};

// Login
window.loginUser = () => {
  const email = document.getElementById("loginEmail").value;
  const pass = document.getElementById("loginPass").value;
  signInWithEmailAndPassword(auth, email, pass).catch(err => alert(err.message));
};

// Logout
window.logoutUser = () => signOut(auth);

// Toggle
window.toggleRegister = () => {
  document.getElementById("loginSection").classList.toggle("hidden");
  document.getElementById("registerSection").classList.toggle("hidden");
};

// Start Game
function startGame() {
  const gameType = parseInt(document.getElementById("gameType").value);
  updateTimer(gameType);
  document.getElementById("gameType").onchange = startGame;
}

// Timer
function updateTimer(gameType) {
  setInterval(() => {
    const now = new Date();
    const end = new Date(Math.ceil(Date.now() / (gameType * 1000)) * gameType * 1000);
    const diff = Math.floor((end - now) / 1000);
    currentPeriod = getPeriod(gameType, now);
    document.getElementById("countdown").innerText = diff;
    document.getElementById("periodDisplay").innerText = currentPeriod;
    if (diff <= 0) runResult(gameType, currentPeriod);
  }, 1000);
}

// Period ID
function getPeriod(type, now) {
  const date = now.toISOString().slice(0,10).replace(/-/g,'');
  const seconds = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
  const index = Math.floor(seconds/type);
  return `${date}-${String(index+1).padStart(4,"0")}`;
}

// Color/Size
function getColor(n){ return n==5 ? "VIOLET" : [1,3,7,9].includes(n) ? "RED" : "GREEN"; }
function getSize(n){ return n >= 5 ? "BIG" : "SMALL"; }

// Run Result
function runResult(type, period) {
  const num = Math.floor(Math.random() * 10);
  const color = getColor(num);
  const size = getSize(num);
  set(ref(db, `results/${type}/${period}`), { number: num, color, size });

  onValue(ref(db, "bets"), snap => {
    const all = snap.val();
    if (!all) return;
    Object.entries(all).forEach(([uid, userBets]) => {
      const bets = userBets?.[period];
      if (!bets) return;
      let winTotal = 0;
      Object.entries(bets).forEach(([id, bet]) => {
        let win = false, mult = 0;
        if (bet.type === "color" && bet.value === color) { win = true; mult = color === "VIOLET" ? 4.5 : 1.96; }
        else if (bet.type === "size" && bet.value === size) { win = true; mult = 1.96; }
        else if (bet.type === "number" && Number(bet.value) === num) { win = true; mult = 8.5; }
        const payout = win ? (bet.amount * mult).toFixed(2) : 0;
        update(ref(db, `bets/${uid}/${period}/${id}`), { win, payout });
        if (win) winTotal += parseFloat(payout);
      });
      if (winTotal > 0) {
        get(ref(db, `users/${uid}`)).then(s => {
          const bal = (s.val().balance || 0) + winTotal;
          update(ref(db, `users/${uid}`), { balance: bal });
          if (uid === currentUser.uid) {
            document.getElementById("wallet").innerText = bal.toFixed(2);
            document.getElementById("winSound").play();
            alert(`You won ₹${winTotal.toFixed(2)}`);
          }
        });
      }
    });
  }, { onlyOnce: true });
}

// Place Bet
window.placeBet = (type, value) => {
  const amt = parseFloat(document.getElementById("betAmount").value);
  if (!amt || amt <= 0) return alert("Enter valid amount");
  if (amt > currentBalance) return alert("Insufficient balance");
  const bet = { type, value, amount: amt, win: null };
  push(ref(db, `bets/${currentUser.uid}/${currentPeriod}`), bet);
  currentBalance -= amt;
  update(ref(db, `users/${currentUser.uid}`), { balance: currentBalance });
  document.getElementById("wallet").innerText = currentBalance.toFixed(2);
};

// Load Profile
function loadProfile() {
  get(ref(db, `users/${currentUser.uid}`)).then(snap => {
    const data = snap.val();
    currentBalance = data.balance;
    document.getElementById("wallet").innerText = currentBalance.toFixed(2);
    document.getElementById("userIdDisplay").innerText = data.userId;
    document.getElementById("referralCodeShow").innerText = data.userId;
    document.getElementById("refEarnings").innerText = (data.refEarnings || 0).toFixed(2);
  });
}

// Bet History
function loadBetHistory() {
  onValue(ref(db, `bets/${auth.currentUser.uid}`), snap => {
    const bets = snap.val();
    const bh = document.getElementById("betHistory");
    bh.innerHTML = "";
    if (!bets) return;
    Object.entries(bets).forEach(([p, blist]) => {
      Object.values(blist).forEach(b => {
        const row = `<tr><td>${p}</td><td>${b.type}</td><td>${b.value}</td><td>${b.amount}</td><td>${b.win === null ? "Pending" : b.win ? "✅" : "❌"}</td></tr>`;
        bh.innerHTML += row;
      });
    });
  });
}

// Number buttons
for (let i=0;i<=9;i++) {
  const btn = document.createElement("button");
  btn.className = "number-btn";
  btn.textContent = i;
  btn.onclick = () => placeBet("number", i);
  document.getElementById("numberButtons").appendChild(btn);
}
</script>
</body>
</html>
